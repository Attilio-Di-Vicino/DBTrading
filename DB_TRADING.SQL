DROP TABLE UTENTE;
DROP TABLE VALUTAZIONE_RISCHIO CASCADE CONSTRAINT;
DROP TABLE CONTO_CORRENTE CASCADE CONSTRAINT;
DROP TABLE COLLEGATO CASCADE CONSTRAINT;
DROP TABLE CONTO_VIRTUALE CASCADE CONSTRAINT;
DROP TABLE MOVIMENTO CASCADE CONSTRAINT;
-- DROP TABLE DEPOSITO;
-- DROP TABLE PRELIEVO;
DROP TABLE WALLET_DECENTRALIZZATO;
DROP TABLE ASSOCIATO CASCADE CONSTRAINT;
DROP TABLE EXCHANGE_DECENTRALIZZATO;
DROP TABLE UNITO CASCADE CONSTRAINT;
DROP TABLE REWARDS CASCADE CONSTRAINT;
DROP TABLE PIATTAFORMA_EXCHANGE CASCADE CONSTRAINT;
DROP TABLE OPERAZIONE CASCADE CONSTRAINT;
DROP TABLE ACQUISTO CASCADE CONSTRAINT;
DROP TABLE VENDITA CASCADE CONSTRAINT;

CREATE TABLE UTENTE(
    CF              CHAR(16)    PRIMARY KEY,
    DATA_DI_NASCITA DATE        NOT NULL,
    NAZIONALITA     VARCHAR(20) NOT NULL,
    NOME            VARCHAR(20) NOT NULL,
    COGNOME         VARCHAR(20) NOT NULL
)

CREATE TABLE VALUTAZIONE_RISCHIO(
    CATEGORIA   VARCHAR(15) NOT NULL, -- CHIAVE DEBOLE 
    BUDGET      NUMBER(9,0) NOT NULL, -- FINO A 9 NUMERI RAPPRESENTABILI
    RISCHIO     NUMBER(2,0) NOT NULL, -- NON PUO' AVERE IL 100% DI RISCHIO (VALORE ESPRESSO IN %)
    CF_UTENTE   CHAR(16)    NOT NULL, -- CHIAVE ESTERNA

    CONSTRAINT  PK_VALUTAZIONE_RISCHIO PRIMARY KEY(CATEGORIA,CF_UTENTE),
    CONSTRAINT  FK_UTENTE FOREIGN KEY (CF_UTENTE) REFERENCES UTENTE(CF) ON DELETE CASCADE,
    CONSTRAINT  CATEGORIE_AMMESSE CHECK ( (CATEGORIA) IN ('INTRADAY','SCALPER','BUY & HOLD') )
)

CREATE TABLE CONTO_CORRENTE(
    NUMERO_CONTO        CHAR(16)    PRIMARY KEY,
    CVV                 CHAR(3)     NOT NULL        UNIQUE,
    DATA_DI_SCADENZA    DATE        NOT NULL,
    CF_UTENTE           CHAR(16)    NOT NULL, -- CHIAVE ESTERNA

    CONSTRAINT  FK_UTENTE2 FOREIGN KEY (CF_UTENTE) REFERENCES UTENTE(CF) ON DELETE CASCADE
)

CREATE TABLE CONTO_VIRTUALE(
    ID              VARCHAR(30) PRIMARY KEY, -- VARCHAR(30) PERCHE POSSIAMO AVERE ID DIVERSI DI PIATTAFORME DIVERSE
    DATA_CREAZIONE  DATE        NOT NULL
)

CREATE TABLE COLLEGATO(
    ID_CONTO_VIRTUALE_C   VARCHAR(30), -- PRIMARY KEY -- CHIAVE ESTERNA ??
    NUMERO_CONTO_C        CHAR(16),    -- PRIMARY KEY -- CHIAVE ESTERNA ??

    CONSTRAINT  PK_COLLEGATO PRIMARY KEY (ID_CONTO_VIRTUALE_C,NUMERO_CONTO_C),
    CONSTRAINT  FK_ID FOREIGN KEY (ID_CONTO_VIRTUALE_C) REFERENCES CONTO_VIRTUALE(ID) ON DELETE CASCADE,
    CONSTRAINT  FK_NUMERO_CONTO FOREIGN KEY (NUMERO_CONTO_C) REFERENCES CONTO_CORRENTE(NUMERO_CONTO) ON DELETE CASCADE
)

CREATE TABLE MOVIMENTO(
    ID_ORDINE               CHAR(20)        PRIMARY KEY,
    QUANTITA                NUMBER(9,2)     NOT NULL,
    DATA_M                  TIMESTAMP,                -- DA AGGIUNGERE NOT NULL
    FEE                     NUMBER(9,2)     NOT NULL,
    TIPO_MOVIMENTO          NUMBER(1,0)     NOT NULL, -- PUO ESSERE SOLO 1 O 2
    ID_CONTO_VIRTUALE_M     VARCHAR(30)     NOT NULL, -- CHIAVE ESTERNA

    CONSTRAINT  FK_ID_CONTO_VIRTUALE FOREIGN KEY (ID_CONTO_VIRTUALE_M) REFERENCES CONTO_VIRTUALE(ID) ON DELETE CASCADE,
    CONSTRAINT  MOVIMENTO_CONSENTITO CHECK ( QUANTITA <> 0 ),
    CONSTRAINT TIPO_MOVIMENTO_CONSENTITO CHECK ( (TIPO_MOVIMENTO = 1) OR (TIPO_MOVIMENTO = 2) )
)

CREATE TABLE WALLET_DECENTRALIZZATO(
    INDIRIZZO    CHAR(42)    PRIMARY KEY,
    NOME_WALLET  VARCHAR(20) NOT NULL,
    BLOCKCHAIN1  VARCHAR(20),
    BLOCKCHAIN2  VARCHAR(20),
    BLOCKCHAIN3  VARCHAR(20),
    BLOCKCHAIN4  VARCHAR(20),
    BLOCKCHAIN5  VARCHAR(20)
)

CREATE TABLE ASSOCIATO(
    ID_CONTO_VIRTUALE_A VARCHAR(30), -- CHIAVE PRIMARIA -- CHIAVE ESTERNA
    INDIRIZZO_W         CHAR(42),    -- CHIAVE PRIMARIA -- CHIAVE ESTERNA

    CONSTRAINT  PK_ASSOCIATO PRIMARY KEY (ID_CONTO_VIRTUALE_A,INDIRIZZO_W),
    CONSTRAINT  FK_ID_A FOREIGN KEY (ID_CONTO_VIRTUALE_A) REFERENCES CONTO_VIRTUALE(ID) ON DELETE CASCADE,
    CONSTRAINT  FK_INDIRIZZO_W FOREIGN KEY (INDIRIZZO_W) REFERENCES WALLET_DECENTRALIZZATO(INDIRIZZO) ON DELETE CASCADE
)

CREATE TABLE EXCHANGE_DECENTRALIZZATO(
    NOME_EXCHANGE    VARCHAR(20)     PRIMARY KEY,
    BLOCKCHAIN       VARCHAR(20)     NOT NULL
)

CREATE TABLE UNITO(
    INDIRIZZO_W_U     CHAR(42),    -- CHIAVE PRIMARIA -- CHIAVE ESTERNA
    NOME_EXCHANGE_U   VARCHAR(20), -- CHIAVE PRIMARIA -- CHIAVE ESTERNA

    CONSTRAINT  PK_UNITO PRIMARY KEY (INDIRIZZO_W_U,NOME_EXCHANGE_U),
    CONSTRAINT  FK_INDIRIZZO_W_U FOREIGN KEY (INDIRIZZO_W_U) REFERENCES WALLET_DECENTRALIZZATO(INDIRIZZO) ON DELETE CASCADE,
    CONSTRAINT  FK_NOME_EXCHANGE_U FOREIGN KEY (NOME_EXCHANGE_U) REFERENCES EXCHANGE_DECENTRALIZZATO(NOME_EXCHANGE) ON DELETE CASCADE
)

CREATE TABLE REWARDS(
    CODICE              CHAR(4)         PRIMARY KEY,
    QUANTITA            NUMBER(2,0)     NOT NULL,
    BLOCKCHAIN_R        VARCHAR(20),
    CONTRATTO           CHAR(42)        NOT NULL,
    DATA_RILASCIO       DATE            NOT NULL,
    NOME_R_C            VARCHAR(20),
    ID_CONTO_VIRTUALE_R VARCHAR(30)     NOT NULL, -- CHIAVE ESTERNA

    CONSTRAINT  FK_ID_CONTO_VIRTUALE_R FOREIGN KEY (ID_CONTO_VIRTUALE_R) REFERENCES CONTO_VIRTUALE(ID) ON DELETE CASCADE
)

CREATE TABLE PIATTAFORMA_EXCHANGE(
    NOME_PIATTAFORMA    VARCHAR(20)     PRIMARY KEY,
    TOKEN_RIFERIMENTO   VARCHAR(20),
    ID_CONTO_VIRTUALE_P VARCHAR(30),    -- CHIAVE ESTERNA

    CONSTRAINT  FK_ID_CONTO_VIRTUALE_P FOREIGN KEY (ID_CONTO_VIRTUALE_P) REFERENCES CONTO_VIRTUALE(ID) ON DELETE CASCADE
)

CREATE TABLE OPERAZIONE(
    TX_HASH             CHAR(66)    PRIMARY KEY,
    PREZZO              NUMBER(9,0) NOT NULL, -- VALUTARE TIPO NUMBER 
    NOME_PROGETTO       VARCHAR(20),
    CONTRATTO_O         CHAR(42)    NOT NULL,
    QUANTITA_O          NUMBER(9,0) NOT NULL,
    DATA_O              DATE        NOT NULL,
    ID_CONTO_VIRTUALE_O VARCHAR(30),          -- CHIAVE ESTERNA

    CONSTRAINT  FK_ID_CONTO_VIRTUALE_O FOREIGN KEY (ID_CONTO_VIRTUALE_O) REFERENCES CONTO_VIRTUALE(ID) ON DELETE CASCADE
)

CREATE TABLE ACQUISTO(
    TX_HASH_A   CHAR(66),   -- CHIAVE ESTERNA
    FROM_A      CHAR(42)    NOT NULL,

    CONSTRAINT FK_TX_HASH_A FOREIGN KEY (TX_HASH_A) REFERENCES OPERAZIONE(TX_HASH) ON DELETE CASCADE
)

CREATE TABLE VENDITA(
    TX_HASH_V   CHAR(66),   -- CHIAVE ESTERNA
    TO_v        CHAR(42)    NOT NULL,

    CONSTRAINT FK_TX_HASH_V FOREIGN KEY (TX_HASH_V) REFERENCES OPERAZIONE(TX_HASH) ON DELETE CASCADE
)