DROP TABLE UTENTE cascade constraints;
DROP TABLE VALUTAZIONE_RISCHIO;
DROP TABLE CARTA_DI_CREDITO cascade constraints;
DROP TABLE PIATTAFORMA_EXCHANGE cascade constraints;
DROP TABLE CONTO_VIRTUALE cascade constraints;
DROP TABLE COLLEGATO;
DROP TABLE MOVIMENTO;
DROP TABLE REWARDS;
DROP TABLE WALLET_DECENTRALIZZATO cascade constraints;
DROP TABLE ASSOCIATO;
DROP TABLE EXCHANGE_DECENTRALIZZATO cascade constraints;
DROP TABLE UNITO;
DROP TABLE SCAMBIO;

CREATE TABLE UTENTE(
    CF              CHAR(16)    NOT NULL PRIMARY KEY,
    DATA_DI_NASCITA DATE        NOT NULL,
    NAZIONALITA     VARCHAR(20) NOT NULL,
    NOME            VARCHAR(20) NOT NULL,
    COGNOME         VARCHAR(20) NOT NULL
);

CREATE TABLE VALUTAZIONE_RISCHIO(
    CATEGORIA   VARCHAR(15) NOT NULL, 
    BUDGET      NUMBER(9,0) NOT NULL, 
    RISCHIO     NUMBER(2,0) NOT NULL,
    CF_UTENTE   CHAR(16)    NOT NULL,

    CONSTRAINT  PK_VALUTAZIONE_RISCHIO PRIMARY KEY(CATEGORIA,CF_UTENTE),
    CONSTRAINT  FK_UTENTE FOREIGN KEY (CF_UTENTE) REFERENCES UTENTE(CF) ON DELETE CASCADE,

    CONSTRAINT  CATEGORIE_AMMESSE CHECK ( (CATEGORIA) IN ('INTRADAY','SCALPER','BUY & HOLD') ),
    CONSTRAINT  MASS_BUDGET CHECK (BUDGET < 100000000 ),
    CONSTRAINT  MASS_RISCHIO CHECK (RISCHIO < 100 )
);

CREATE TABLE CARTA_DI_CREDITO(
    NUMERO_CARTA        CHAR(16)    NOT NULL PRIMARY KEY,
    CVV                 CHAR(3)     NOT NULL UNIQUE,
    DATA_DI_SCADENZA    DATE        NOT NULL,
    BANCA               VARCHAR(20) NOT NULL,
    CF_UTENTE           CHAR(16)    NOT NULL,

    CONSTRAINT  FK_UTENTE2 FOREIGN KEY (CF_UTENTE) REFERENCES UTENTE(CF) ON DELETE CASCADE
);

CREATE TABLE PIATTAFORMA_EXCHANGE(
    NOME_PIATTAFORMA    VARCHAR(20)     NOT NULL PRIMARY KEY,
    TOKEN_RIFERIMENTO   VARCHAR(20)     NOT NULL,
    CONTRATTO_P         CHAR(42)        NOT NULL
);

CREATE TABLE CONTO_VIRTUALE(
    ID_CONTO_VIRTUALE   VARCHAR(30) NOT NULL,
    NOME_PIATTAFORMA_CV VARCHAR(20) NOT NULL,
    DATA_CREAZIONE      DATE        NOT NULL,
    VALUTA              VARCHAR(10) NOT NULL,

    CONSTRAINT PK_CONTO_VIRTUALE PRIMARY KEY (ID_CONTO_VIRTUALE,NOME_PIATTAFORMA_CV),
    CONSTRAINT FK_PIATTAFORMA FOREIGN KEY (NOME_PIATTAFORMA_CV) REFERENCES PIATTAFORMA_EXCHANGE(NOME_PIATTAFORMA) ON DELETE CASCADE,
    CONSTRAINT VALUTE_DISPONIBILI CHECK (VALUTA IN ('EUR','USD','CHF'))
);

CREATE TABLE COLLEGATO(
    ID_CONTO_VIRTUALE_C   VARCHAR(30)   NOT NULL, 
    NOME_PIATTAFORMA_C    VARCHAR(20)   NOT NULL,
    NUMERO_CARTA_C        CHAR(16)      NOT NULL, 

    CONSTRAINT  PK_COLLEGATO PRIMARY KEY (ID_CONTO_VIRTUALE_C,NUMERO_CARTA_C,NOME_PIATTAFORMA_C),
    CONSTRAINT  FK_ID FOREIGN KEY (ID_CONTO_VIRTUALE_C,NOME_PIATTAFORMA_C) REFERENCES CONTO_VIRTUALE(ID_CONTO_VIRTUALE,NOME_PIATTAFORMA_CV) ON DELETE CASCADE,
    CONSTRAINT  FK_NUMERO_CONTO FOREIGN KEY (NUMERO_CARTA_C) REFERENCES CARTA_DI_CREDITO(NUMERO_CARTA) ON DELETE CASCADE
);

CREATE TABLE MOVIMENTO(
    ID_ORDINE               CHAR(20)        NOT NULL PRIMARY KEY,
    QUANTITA_M              NUMBER(9,2)     NOT NULL,
    DATA_M                  DATE            NOT NULL,
    FEE_M                   NUMBER(4,2)     NOT NULL,
    TIPO_MOVIMENTO          NUMBER(2,0)     NOT NULL,
    ID_CONTO_VIRTUALE_M     VARCHAR(30)     NOT NULL, 
    NUMERO_CARTA_M          CHAR(16)        NOT NULL, 
    NOME_PIATTAFORMA_M      VARCHAR(30)     NOT NULL,

    CONSTRAINT  FK_ID_CONTO_VIRTUALE FOREIGN KEY (ID_CONTO_VIRTUALE_M,NOME_PIATTAFORMA_M) REFERENCES CONTO_VIRTUALE(ID_CONTO_VIRTUALE,NOME_PIATTAFORMA_CV) ON DELETE CASCADE,
    CONSTRAINT  FK_CARTA_DI_CREDITO FOREIGN KEY (NUMERO_CARTA_M) REFERENCES CARTA_DI_CREDITO(NUMERO_CARTA) ON DELETE CASCADE,

    CONSTRAINT  MOVIMENTO_CONSENTITO CHECK ( QUANTITA_M <> 0 ),
    CONSTRAINT  TIPO_MOVIMENTO_CONSENTITO CHECK ( (TIPO_MOVIMENTO = 1) OR (TIPO_MOVIMENTO = 2) ),
    CONSTRAINT  MASS_FEE CHECK (FEE_M < 100)
);

CREATE TABLE REWARDS(
    CODICE              NUMBER          GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    QUANTITA_R          NUMBER(9,0)     NOT NULL,
    BLOCKCHAIN_R        VARCHAR(20),
    CONTRATTO_R         CHAR(42)        NOT NULL,
    DATA_RILASCIO       DATE            NOT NULL,
    NOME_R              VARCHAR(20),
    ID_CONTO_VIRTUALE_R VARCHAR(30)     NOT NULL,
    NOME_PIATTAFORMA_R  VARCHAR(20)     NOT NULL,

    CONSTRAINT  FK_ID_CONTO_VIRTUALE_R FOREIGN KEY (ID_CONTO_VIRTUALE_R,NOME_PIATTAFORMA_R) REFERENCES CONTO_VIRTUALE(ID_CONTO_VIRTUALE,NOME_PIATTAFORMA_CV) ON DELETE CASCADE,
    CONSTRAINT  MASS_QUANTITA CHECK (QUANTITA_R < 100000000 )
);

CREATE TABLE WALLET_DECENTRALIZZATO(
    INDIRIZZO    CHAR(42)    NOT NULL PRIMARY KEY,
    NOME_WALLET  VARCHAR(20) NOT NULL,
    BLOCKCHAIN1  VARCHAR(20),
    BLOCKCHAIN2  VARCHAR(20),
    BLOCKCHAIN3  VARCHAR(20),
    BLOCKCHAIN4  VARCHAR(20),
    BLOCKCHAIN5  VARCHAR(20)
);

CREATE TABLE ASSOCIATO(
    ID_CONTO_VIRTUALE_A   VARCHAR(30)   NOT NULL, 
    NOME_PIATTAFORMA_A    VARCHAR(20)   NOT NULL,
    INDIRIZZO_A           CHAR(42)      NOT NULL,

    CONSTRAINT  PK_ASSOCIATO PRIMARY KEY (ID_CONTO_VIRTUALE_A,NOME_PIATTAFORMA_A,INDIRIZZO_A),
    CONSTRAINT  FK_CV FOREIGN KEY (ID_CONTO_VIRTUALE_A,NOME_PIATTAFORMA_A) REFERENCES CONTO_VIRTUALE(ID_CONTO_VIRTUALE,NOME_PIATTAFORMA_CV) ON DELETE CASCADE,
    CONSTRAINT  FK_WALLET FOREIGN KEY (INDIRIZZO_A) REFERENCES WALLET_DECENTRALIZZATO(INDIRIZZO) ON DELETE CASCADE
);

CREATE TABLE EXCHANGE_DECENTRALIZZATO(
    NOME_EXCHANGE    VARCHAR(20)    NOT NULL PRIMARY KEY,
    BLOCKCHAIN       VARCHAR(20)    NOT NULL
);

CREATE TABLE UNITO(
    INDIRIZZO_U     CHAR(42)    NOT NULL,
    NOME_EXCHANGE_U VARCHAR(20) NOT NULL,

    CONSTRAINT PK_UNITO PRIMARY KEY(INDIRIZZO_U,NOME_EXCHANGE_U),
    CONSTRAINT FK_WALLET_U FOREIGN KEY (INDIRIZZO_U) REFERENCES WALLET_DECENTRALIZZATO(INDIRIZZO) ON DELETE CASCADE,
    CONSTRAINT FK_DEX FOREIGN KEY (NOME_EXCHANGE_U) REFERENCES EXCHANGE_DECENTRALIZZATO(NOME_EXCHANGE) ON DELETE CASCADE
);

CREATE TABLE SCAMBIO(
    TX_HASH             CHAR(66)        NOT NULL PRIMARY KEY,
    QUANTITA_SCAMBIATA  NUMBER(18,4)    NOT NULL,
    FEE_S               NUMBER(4,2)     NOT NULL,
    CONTRATTO_S         CHAR(42)        NOT NULL,
    DATA_S              DATE            NOT NULL,
    QUANTITA_OTTENUTA   NUMBER(18,4)    NOT NULL,
    VALUTA_OTTENUTA     VARCHAR(20)     NOT NULL,
    VALUTA_SCAMBIATA    VARCHAR(20)     NOT NULL,
    ID_CONTO_VIRTUALE_S VARCHAR(30)     NOT NULL,
    NOME_PIATTAFORMA_S  VARCHAR(30)     NOT NULL,
    NOME_EXCHANGE_DEX   VARCHAR(20)     NOT NULL,

    CONSTRAINT FK_ID_CONTO_VIRTUALE_S FOREIGN KEY (ID_CONTO_VIRTUALE_S,NOME_PIATTAFORMA_S) REFERENCES CONTO_VIRTUALE(ID_CONTO_VIRTUALE,NOME_PIATTAFORMA_CV) ON DELETE CASCADE,
    CONSTRAINT FK_DEX_S FOREIGN KEY (NOME_EXCHANGE_DEX) REFERENCES EXCHANGE_DECENTRALIZZATO(NOME_EXCHANGE) ON DELETE CASCADE
);