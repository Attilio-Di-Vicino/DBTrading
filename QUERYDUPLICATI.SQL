-- TRIGGER 6
SELECT CF_UTENTE
FROM CARTA_DI_CREDITO
WHERE NUMERO_CARTA IN (
    SELECT NUMERO_CARTA_C
    FROM COLLEGATO
    WHERE ID_CONTO_VIRTUALE_C = '38480029763762467178' AND NOME_PIATTAFORMA_C = 'BITPANDA'
);
        
        
SELECT CF_UTENTE
    FROM CARTA_DI_CREDITO CC JOIN COLLEGATO C2 ON CC.NUMERO_CARTA = C2.NUMERO_CARTA_C
        WHERE C2.ID_CONTO_VIRTUALE_C = '38480029763762467178' AND C2.NOME_PIATTAFORMA_C = 'BITPANDA';

CREATE OR REPLACE TRIGGER VERIFICA_CARTE_SU_CONTO_VIRTUALE
BEFORE INSERT ON COLLEGATO
FOR EACH ROW
DECLARE
    PIU_UTENTI  EXCEPTION;
    NCARTA      CHAR(16);
    CFUTENTE    CHAR(16);
BEGIN

    SELECT CF_UTENTE
    INTO CFUTENTE
    FROM CARTA_DI_CREDITO
    WHERE NUMERO_CARTA = :NEW.NUMERO_CARTA_C;

    FOR i IN (
        SELECT CF_UTENTE
            FROM CARTA_DI_CREDITO CC JOIN COLLEGATO C2 ON CC.NUMERO_CARTA = C2.NUMERO_CARTA_C
                WHERE C2.ID_CONTO_VIRTUALE_C = :NEW.ID_CONTO_VIRTUALE_C AND C2.NOME_PIATTAFORMA_C = :NEW.NOME_PIATTAFORMA_C
    )
    LOOP
        IF CFUTENTE != i.CF_UTENTE THEN
            RAISE PIU_UTENTI;
        END IF;
    END LOOP;

    EXCEPTION WHEN PIU_UTENTI THEN
        RAISE_APPLICATION_ERROR(-6000,'ERRORE, CARTE COLLEGATE A PIU DI UNA PERSONA!');

END VERIFICA_CARTE_SU_CONTO_VIRTUALE;

-- TRIGGER 8
SELECT COUNT(*)
--    INTO CONTA
FROM UNITO
WHERE NOME_EXCHANGE_U = 'UNISWAP' AND INDIRIZZO_U IN (
    SELECT INDIRIZZO_A
    FROM ASSOCIATO
    WHERE ID_CONTO_VIRTUALE_A = '38480029763762467178' AND NOME_PIATTAFORMA_A = 'BITPANDA'
);
    
SELECT COUNT(*)
    FROM UNITO U JOIN ASSOCIATO A1 ON  U.NOME_EXCHANGE_U = 'UNISWAP' AND U.INDIRIZZO_U IN A1.INDIRIZZO_A
        WHERE A1.ID_CONTO_VIRTUALE_A = '38480029763762467178' AND A1.NOME_PIATTAFORMA_A = 'BITPANDA';

CREATE OR REPLACE TRIGGER CONTROLLO_SCAMBIO
BEFORE INSERT ON SCAMBIO
FOR EACH ROW
DECLARE
    NON_COLLEGATO EXCEPTION;
    CONTA NUMBER := 0;
BEGIN

    SELECT COUNT(*)
    INTO CONTA
        FROM UNITO U JOIN ASSOCIATO A1 ON  U.NOME_EXCHANGE_U = :NEW.NOME_EXCHANGE_DEX AND U.INDIRIZZO_U IN A1.INDIRIZZO_A
            WHERE A1.ID_CONTO_VIRTUALE_A = :NEW.ID_CONTO_VIRTUALE_S AND A1.NOME_PIATTAFORMA_A = :NEW.NOME_PIATTAFORMA_S;

    IF CONTA < 1 THEN
        RAISE NON_COLLEGATO;
    END IF;

    EXCEPTION WHEN NON_COLLEGATO THEN
        RAISE_APPLICATION_ERROR(-8000,'QUESTO SCAMBIO NON PUO ESSERE EFFETTUATO');

END CONTROLLO_SCAMBIO;

-- PROCEDURA 1
SELECT NUMERO_CARTA_C,NOME_PIATTAFORMA_C,ID_CONTO_VIRTUALE_C
FROM COLLEGATO
WHERE NUMERO_CARTA_C IN (
    SELECT NUMERO_CARTA
    FROM CARTA_DI_CREDITO
    WHERE DATA_DI_SCADENZA < SYSDATE
);

SELECT NUMERO_CARTA_C,NOME_PIATTAFORMA_C,ID_CONTO_VIRTUALE_C
    FROM COLLEGATO C1 JOIN CARTA_DI_CREDITO CDC ON C1.NUMERO_CARTA_C = CDC.NUMERO_CARTA
        WHERE CDC.DATA_DI_SCADENZA < SYSDATE;

CREATE OR REPLACE PROCEDURE ELIMINARE_CARTE_SCADUTE
IS
    DATACREAZIONE_  DATE;
    TOTDEPOSITI_ NUMBER;
    CONTATORE_ NUMBER;
    CONTROLLO NUMBER := 0;
BEGIN
    FOR i IN
        (
            SELECT NUMERO_CARTA_C,NOME_PIATTAFORMA_C,ID_CONTO_VIRTUALE_C
                FROM COLLEGATO C1 JOIN CARTA_DI_CREDITO CDC ON C1.NUMERO_CARTA_C = CDC.NUMERO_CARTA
                    WHERE CDC.DATA_DI_SCADENZA < SYSDATE
        )
    LOOP

        SELECT DATA_CREAZIONE
        INTO DATACREAZIONE_
        FROM CONTO_VIRTUALE
        WHERE ID_CONTO_VIRTUALE = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_CV = i.NOME_PIATTAFORMA_C;
        
        TOTDEPOSITI_ := TOTDEPOSITO(i.ID_CONTO_VIRTUALE_C,i.NOME_PIATTAFORMA_C);

        IF TOTDEPOSITI_ < 500 AND (FLOOR((SYSDATE - DATACREAZIONE_) / 365.25) < 1) THEN
            DELETE FROM CARTA_DI_CREDITO WHERE NUMERO_CARTA = i.NUMERO_CARTA_C;
            DELETE FROM COLLEGATO WHERE NUMERO_CARTA_C = i.NUMERO_CARTA_C AND ID_CONTO_VIRTUALE_C = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_C = i.NOME_PIATTAFORMA_C;
            DBMS_OUTPUT.PUT_LINE('E STATA CANCELLATA LA CARTA NUMERO: ' || i.NUMERO_CARTA_C);

            CONTROLLO := 1;

            SELECT COUNT(NUMERO_CARTA_C)
            INTO CONTATORE_
            FROM COLLEGATO
            WHERE NUMERO_CARTA_C = i.NUMERO_CARTA_C AND ID_CONTO_VIRTUALE_C = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_C = i.NOME_PIATTAFORMA_C;

            IF CONTATORE_ < 1 THEN
                DELETE FROM CONTO_VIRTUALE WHERE ID_CONTO_VIRTUALE = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_CV = i.NOME_PIATTAFORMA_C;
                DBMS_OUTPUT.PUT_LINE('E STATO CANCELLATO IL CONTO VIRTUALE CON ID: ' || i.ID_CONTO_VIRTUALE_C || ' E NOME: ' || i.NOME_PIATTAFORMA_C);
            END IF;

        END IF;
        
    END LOOP;

    IF CONTROLLO = 0 THEN
        DBMS_OUTPUT.PUT_LINE('NON E STATA CANCELLATA NESSUNA CARTA!');
    END IF;

END ELIMINARE_CARTE_SCADUTE;

-- PROCEDURE 2
SELECT NOME,COGNOME
--INTO NOM_,COGN_
FROM UTENTE
WHERE CF = (
    SELECT CF_UTENTE
    FROM CARTA_DI_CREDITO
    WHERE NUMERO_CARTA = (
        SELECT NUMERO_CARTA_C
        FROM COLLEGATO
        WHERE ID_CONTO_VIRTUALE_C = '38480029763762467178' AND NOME_PIATTAFORMA_C = 'BITPANDA'
        FETCH FIRST 1 ROWS ONLY
    )
);
        
SELECT NOME,COGNOME
    FROM UTENTE U JOIN (
        SELECT CF_UTENTE
            FROM CARTA_DI_CREDITO CDC JOIN COLLEGATO C1 ON CDC.NUMERO_CARTA = C1.NUMERO_CARTA_C
                WHERE C1.ID_CONTO_VIRTUALE_C = '38480029763762467178' AND C1.NOME_PIATTAFORMA_C = 'BITPANDA'
                FETCH FIRST 1 ROWS ONLY
    ) CDC ON U.CF = CDC.CF_UTENTE;

CREATE OR REPLACE PROCEDURE PREMIO
IS
    TOTDEP_ NUMBER;
    MASSIMO NUMBER := 0;
    NOM_    VARCHAR(30);
    COGN_    VARCHAR(30);
    TOKEN VARCHAR(20);
    CONTRATTO_ CHAR(42);
    QUANTITAR NUMBER;
BEGIN

    FOR i IN (
        SELECT ID_CONTO_VIRTUALE,NOME_PIATTAFORMA_CV
        FROM CONTO_VIRTUALE
    )
    LOOP

        TOTDEP_ := TOTDEPOSITO(i.ID_CONTO_VIRTUALE,i.NOME_PIATTAFORMA_CV);

        IF MASSIMO < TOTDEP_ THEN
            MASSIMO := TOTDEP_;
        END IF;

    END LOOP;

    FOR j IN (
        SELECT ID_CONTO_VIRTUALE,NOME_PIATTAFORMA_CV
        FROM CONTO_VIRTUALE
    )
    LOOP

        TOTDEP_ := TOTDEPOSITO(j.ID_CONTO_VIRTUALE,j.NOME_PIATTAFORMA_CV);

        SELECT NOME,COGNOME
        INTO NOM_,COGN_
            FROM UTENTE U JOIN (
                SELECT CF_UTENTE
                    FROM CARTA_DI_CREDITO CDC JOIN COLLEGATO C1 ON CDC.NUMERO_CARTA = C1.NUMERO_CARTA_C
                        WHERE C1.ID_CONTO_VIRTUALE_C = j.ID_CONTO_VIRTUALE AND C1.NOME_PIATTAFORMA_C = j.NOME_PIATTAFORMA_CV
                        FETCH FIRST 1 ROWS ONLY
            ) CDC ON U.CF = CDC.CF_UTENTE;

        SELECT TOKEN_RIFERIMENTO
        INTO TOKEN
        FROM PIATTAFORMA_EXCHANGE
        WHERE j.NOME_PIATTAFORMA_CV = NOME_PIATTAFORMA;

        IF MASSIMO = TOTDEP_ THEN

        QUANTITAR := FLOOR(MASSIMO/100);

            INSERT INTO REWARDS(QUANTITA_R,DATA_RILASCIO,NOME_R,NOME_PIATTAFORMA_R,ID_CONTO_VIRTUALE_R) VALUES
            (QUANTITAR,SYSDATE+1,TOKEN,j.NOME_PIATTAFORMA_CV,j.ID_CONTO_VIRTUALE);

            DBMS_OUTPUT.PUT_LINE(NOM_ || ' ' || COGN_ || ' HA VINTO UN PREMIO!');
            
        END IF;
    
    END LOOP;
END PREMIO;

-- PROCEDURE 3
-- STESSA QUERY PROCEDURE 2 IDENTICA

-- RPOCEDURA 4
SELECT ID_CONTO_VIRTUALE_C,NOME_PIATTAFORMA_C
FROM COLLEGATO
WHERE NUMERO_CARTA_C IN (
    SELECT NUMERO_CARTA
    FROM CARTA_DI_CREDITO
    WHERE CARTA_DI_CREDITO.CF_UTENTE = 'RSSLCU80P15F839C'
);


SELECT ID_CONTO_VIRTUALE_C,NOME_PIATTAFORMA_C
    FROM COLLEGATO C1 JOIN CARTA_DI_CREDITO CDC ON C1.NUMERO_CARTA_C = CDC.NUMERO_CARTA
        WHERE CDC.CF_UTENTE = 'RSSLCU80P15F839C';

CREATE OR REPLACE PROCEDURE AUMENTA_RISCHIO(CODICEFISCALE IN VARCHAR)
IS
    VALUTA VARCHAR(20);
    SALDO NUMBER;
    RIS NUMBER;
    AU_RIS NUMBER;
    CATE VARCHAR(20);
    CONTROLLO NUMBER := 0;
BEGIN

    FOR i IN (
        SELECT ID_CONTO_VIRTUALE_C,NOME_PIATTAFORMA_C
            FROM COLLEGATO C1 JOIN CARTA_DI_CREDITO CDC ON C1.NUMERO_CARTA_C = CDC.NUMERO_CARTA
                WHERE CDC.CF_UTENTE = CODICEFISCALE
    )
    LOOP

        SELECT TOKEN_RIFERIMENTO
        INTO VALUTA
        FROM PIATTAFORMA_EXCHANGE
        WHERE NOME_PIATTAFORMA = i.NOME_PIATTAFORMA_C;

        SALDO := SALDOVAL(i.ID_CONTO_VIRTUALE_C,i.NOME_PIATTAFORMA_C,VALUTA);

        SELECT RISCHIO,AUMENTO_RISCHIO,CATEGORIA
        INTO RIS,AU_RIS,CATE
        FROM VALUTAZIONE_RISCHIO
        WHERE VALUTAZIONE_RISCHIO.CF_UTENTE = CODICEFISCALE;

        IF SALDO >= 500 THEN
            CONTROLLO := 1;
        END IF;
    
    END LOOP;

    IF CONTROLLO = 1 THEN
        UPDATE VALUTAZIONE_RISCHIO SET RISCHIO = RIS + AU_RIS WHERE CATEGORIA = CATE AND VALUTAZIONE_RISCHIO.CF_UTENTE = CODICEFISCALE;
        COMMIT;
        DBMS_OUTPUT.PUT_LINE('IL TUO RISCHIO E AUMENTATO');
    ELSE
        DBMS_OUTPUT.PUT_LINE('IL TUO RISCHIO NON E AUMENTATO');
    END IF;

END AUMENTA_RISCHIO;

-- PROCEDURE 5

SELECT TIPO_MOVIMENTO,QUANTITA_M,DATA_M,NUMERO_CARTA_M,FEE_M
FROM MOVIMENTO 
WHERE NUMERO_CARTA_M IN (
    SELECT NUMERO_CARTA
    FROM CARTA_DI_CREDITO
    WHERE CF_UTENTE = 'RSSLCU80P15F839C'
)
ORDER BY DATA_M ASC;

SELECT TIPO_MOVIMENTO,QUANTITA_M,DATA_M,NUMERO_CARTA_M,FEE_M
    FROM MOVIMENTO M1 JOIN CARTA_DI_CREDITO CDC ON M1.NUMERO_CARTA_M = CDC.NUMERO_CARTA
        WHERE CDC.CF_UTENTE = 'RSSLCU80P15F839C'
            ORDER BY DATA_M ASC;

-- PROCEDURE 5
SELECT VALUTA_OTTENUTA,QUANTITA_OTTENUTA,VALUTA_SCAMBIATA,QUANTITA_SCAMBIATA,DATA_S,FEE_S
FROM SCAMBIO
WHERE ID_CONTO_VIRTUALE_S IN (
    SELECT ID_CONTO_VIRTUALE_C
    FROM COLLEGATO
    WHERE NUMERO_CARTA_C IN (
        SELECT NUMERO_CARTA
        FROM CARTA_DI_CREDITO
        WHERE CF_UTENTE = 'VRDLGU79M19F839M'
    )
) AND NOME_PIATTAFORMA_S IN (
    SELECT NOME_PIATTAFORMA_C
    FROM COLLEGATO
    WHERE NUMERO_CARTA_C IN (
        SELECT NUMERO_CARTA
        FROM CARTA_DI_CREDITO
        WHERE CF_UTENTE = 'VRDLGU79M19F839M'
    )
)
ORDER BY DATA_S ASC;
    

    
SELECT VALUTA_OTTENUTA,QUANTITA_OTTENUTA,VALUTA_SCAMBIATA,QUANTITA_SCAMBIATA,DATA_S,FEE_S
    FROM SCAMBIO S JOIN (
        SELECT ID_CONTO_VIRTUALE_C
            FROM COLLEGATO C1 JOIN CARTA_DI_CREDITO CDC ON C1.NUMERO_CARTA_C = CDC.NUMERO_CARTA
                WHERE CDC.CF_UTENTE = 'VRDLGU79M19F839M'
    ) C1 ON S.ID_CONTO_VIRTUALE_S = C1.ID_CONTO_VIRTUALE_C
        WHERE NOME_PIATTAFORMA_S IN (
            SELECT NOME_PIATTAFORMA_C
                FROM COLLEGATO C2 JOIN CARTA_DI_CREDITO CDC ON C2.NUMERO_CARTA_C = CDC.NUMERO_CARTA
                    WHERE CDC.CF_UTENTE = 'VRDLGU79M19F839M'
        ) ORDER BY DATA_S ASC;

CREATE OR REPLACE PROCEDURE ESTRATTO(CODFISCALE IN VARCHAR)
IS
    MOV VARCHAR(20);
BEGIN

    DBMS_OUTPUT.PUT_LINE('ESTRATTO CONTO:');
    FOR i IN (
        SELECT TIPO_MOVIMENTO,QUANTITA_M,DATA_M,NUMERO_CARTA_M,FEE_M
            FROM MOVIMENTO M1 JOIN CARTA_DI_CREDITO CDC ON M1.NUMERO_CARTA_M = CDC.NUMERO_CARTA
                WHERE CDC.CF_UTENTE = CODFISCALE
                    ORDER BY DATA_M ASC
    )
    LOOP
        IF i.TIPO_MOVIMENTO = 1 THEN
            MOV := 'DEPOSITO';
        ELSE
            MOV := 'PRELIEVO';
        END IF;

        DBMS_OUTPUT.PUT_LINE(MOV || ':' || i.QUANTITA_M || '¢' || ' DATA:' || i.DATA_M || ' ' || ' COMMISSIONI:' || i.FEE_M || ' CARTA:' || i.NUMERO_CARTA_M);
    END LOOP;

    DBMS_OUTPUT.PUT_LINE('ESTRATTO CRYPTO:');
    FOR j IN (
        SELECT VALUTA_OTTENUTA,QUANTITA_OTTENUTA,VALUTA_SCAMBIATA,QUANTITA_SCAMBIATA,DATA_S,FEE_S
            FROM SCAMBIO S JOIN (
                SELECT ID_CONTO_VIRTUALE_C
                    FROM COLLEGATO C1 JOIN CARTA_DI_CREDITO CDC ON C1.NUMERO_CARTA_C = CDC.NUMERO_CARTA
                        WHERE CDC.CF_UTENTE = CODFISCALE
            ) C1 ON S.ID_CONTO_VIRTUALE_S = C1.ID_CONTO_VIRTUALE_C
                WHERE NOME_PIATTAFORMA_S IN (
                    SELECT NOME_PIATTAFORMA_C
                        FROM COLLEGATO C2 JOIN CARTA_DI_CREDITO CDC ON C2.NUMERO_CARTA_C = CDC.NUMERO_CARTA
                            WHERE CDC.CF_UTENTE = CODFISCALE
                ) ORDER BY DATA_S ASC
    )
    LOOP
        DBMS_OUTPUT.PUT_LINE(j.VALUTA_OTTENUTA || ':' || j.QUANTITA_OTTENUTA || ' ACQUISTATI CON: ' || j.VALUTA_SCAMBIATA || ':' || j.QUANTITA_SCAMBIATA || ' FEE PAGATE:' || j.FEE_S ||' IN DATA:' || j.DATA_S);
    END LOOP;

END ESTRATTO;