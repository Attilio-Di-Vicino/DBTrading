/*
    3- ESTRATTO CONTO E SE NEGLI ULTIMI 30 GIORNI HAI EFFETTUATO ALMENO 10 OPERAIONE ALLORA RICEVRAI UNA REWARDS
    TESTATO E FUNZIONANTE
*/
CREATE OR REPLACE PROCEDURE ESTRATTO_CONTO(CODICEFISCALE_ IN VARCHAR,IDCONTOVIRTUALE_ IN VARCHAR,NOMEP_ IN VARCHAR)
IS
    NOME_ VARCHAR(30);
    COGNOME_ VARCHAR(30);
    MOV VARCHAR(20);
    TOKEN_ VARCHAR(20);
    CONTRATTO_ CHAR(42);
    CONTROLLO NUMBER := 0;
    CONTATORE NUMBER := 0;
    SALDO NUMBER := 0;
    VALUTA_ VARCHAR(20);
BEGIN

    SELECT NOME,COGNOME
    INTO NOME_,COGNOME_
    FROM UTENTE
    WHERE CF = CODICEFISCALE_;

    SELECT COUNT(ID_ORDINE)
    INTO CONTROLLO
    FROM MOVIMENTO
    WHERE ID_CONTO_VIRTUALE_M = IDCONTOVIRTUALE_ AND NOME_PIATTAFORMA_M = NOMEP_;

    IF CONTROLLO > 0 THEN

        DBMS_OUTPUT.PUT_LINE('ESTRATTO CONTO DI ' || NOME_ || ' ' || COGNOME_);
        FOR i IN(
            SELECT ID_ORDINE,QUANTITA_M,DATA_M,FEE_M,TIPO_MOVIMENTO,NUMERO_CARTA_M
            FROM MOVIMENTO
            WHERE ID_CONTO_VIRTUALE_M = IDCONTOVIRTUALE_ AND NOME_PIATTAFORMA_M = NOMEP_
        )

        LOOP
            IF i.TIPO_MOVIMENTO = 1 THEN
                MOV := 'DEPOSITO';
            ELSE
                MOV := 'PRELIEVO';
            END IF;

            DBMS_OUTPUT.PUT_LINE(MOV || ':' || i.QUANTITA_M || '¢' || ' DATA:' || i.DATA_M || ' ' || ' COMMISSIONI:' || i.FEE_M || ' CARTA:' || i.NUMERO_CARTA_M || ' ID:' || i.ID_ORDINE);

        END LOOP;

        SELECT VALUTA
        INTO VALUTA_
        FROM CONTO_VIRTUALE
        WHERE NOME_PIATTAFORMA_CV = NOMEP_ AND ID_CONTO_VIRTUALE = IDCONTOVIRTUALE_;

        SALDO := SALDOVAL(IDCONTOVIRTUALE_,NOMEP_,VALUTA_);
        DBMS_OUTPUT.PUT_LINE('IL SALDO ATTUALE E ' || VALUTA_ || ': ' || SALDO);

        SELECT COUNT(ID_ORDINE)
        INTO CONTATORE
        FROM MOVIMENTO
        WHERE (SYSDATE - DATA_M) <= 30 AND ID_CONTO_VIRTUALE_M = IDCONTOVIRTUALE_ AND NOME_PIATTAFORMA_M = NOMEP_;

        SELECT TOKEN_RIFERIMENTO,CONTRATTO_P
        INTO TOKEN_,CONTRATTO_
        FROM PIATTAFORMA_EXCHANGE
        WHERE NOMEP_ = NOME_PIATTAFORMA;

        IF CONTATORE >= 10 THEN
            INSERT INTO REWARDS(QUANTITA_R,CONTRATTO_R,DATA_RILASCIO,NOME_R,NOME_PIATTAFORMA_R,ID_CONTO_VIRTUALE_R) VALUES
            (10,CONTRATTO_,SYSDATE+1,TOKEN_,NOMEP_,IDCONTOVIRTUALE_);
            DBMS_OUTPUT.PUT_LINE('CIAO ' || NOME_ || ' ' || COGNOME_ || ' HAI VINTO UN PREMIO! DOMANI TI VERRA RILASCIATO');
        ELSE
            DBMS_OUTPUT.PUT_LINE('CIAO ' || NOME_ || ' ' || COGNOME_ || ' NON HAI RAGGIUNTO I 10 MOVIMENTI NEGLI ULTIMI 30 GIORNI!');
        END IF;

    ELSE
        DBMS_OUTPUT.PUT_LINE('SU QUESTO CONTO NON CI SONO MOVIEMNTI!');
    END IF;
 
END ESTRATTO_CONTO;
/*
    4- ESTRATTO IN CRYPTO COMPRESO DI REWARDS RILASCIATE - SCAMBI EFFETTUATI,
       E SE NEGLI ULTIMI 30 GIORNI HAI EFFETTUATO ALMENO 10 OPERAIONE ALLORA RICEVRAI UNA REWARDS 
*/
CREATE OR REPLACE PROCEDURE ESTRATTO_IN_CRYPTO(IDCONTOVIRTUALE IN VARCHAR,NOMEPIATTAFORMA IN VARCHAR)
IS
    TOKEN_ VARCHAR(20);
    CONTRATTO_ CHAR(42);
    CONTROLLO NUMBER := 0;
    CONTATORE NUMBER := 0;
BEGIN

    SELECT COUNT(TX_HASH)
    INTO CONTROLLO
    FROM SCAMBIO
    WHERE ID_CONTO_VIRTUALE_S = IDCONTOVIRTUALE AND NOME_PIATTAFORMA_S = NOMEPIATTAFORMA;

    IF CONTROLLO > 0 THEN 

        DBMS_OUTPUT.PUT_LINE('ESTRATTO CRYPTO:');
        FOR k IN (
            SELECT *
            FROM SCAMBIO
            WHERE ID_CONTO_VIRTUALE_S = IDCONTOVIRTUALE AND NOME_PIATTAFORMA_S = NOMEPIATTAFORMA
        )
        LOOP
            DBMS_OUTPUT.PUT_LINE(k.VALUTA_OTTENUTA || ':' || k.QUANTITA_OTTENUTA || ' ACQUISTATI CON: ' || k.VALUTA_SCAMBIATA || ':' || k.QUANTITA_SCAMBIATA || ' IN DATA:' || k.DATA_S);
        END LOOP;
        
        DBMS_OUTPUT.PUT_LINE('REWARDS RICEVUTI:');
        FOR i IN (
            SELECT *
            FROM REWARDS
            WHERE ID_CONTO_VIRTUALE_R = IDCONTOVIRTUALE AND NOME_PIATTAFORMA_R = NOMEPIATTAFORMA AND DATA_RILASCIO > SYSDATE+1
        )
        LOOP
            DBMS_OUTPUT.PUT_LINE(i.NOME_R || ':' || i.QUANTITA_R || ' IN DATA:' || i.DATA_RILASCIO);
        END LOOP;

        SELECT COUNT(TX_HASH)
        INTO CONTATORE
        FROM SCAMBIO
        WHERE (SYSDATE - DATA_S) <= 30 AND ID_CONTO_VIRTUALE_S = IDCONTOVIRTUALE AND NOME_PIATTAFORMA_S = NOMEPIATTAFORMA;

        SELECT TOKEN_RIFERIMENTO,CONTRATTO_P
        INTO TOKEN_,CONTRATTO_
        FROM PIATTAFORMA_EXCHANGE
        WHERE NOMEPIATTAFORMA = NOME_PIATTAFORMA;

        IF CONTATORE >= 10 THEN
            INSERT INTO REWARDS(QUANTITA_R,CONTRATTO_R,DATA_RILASCIO,NOME_R,NOME_PIATTAFORMA_R,ID_CONTO_VIRTUALE_R) VALUES
            (10,CONTRATTO_,SYSDATE+1,TOKEN_,NOMEPIATTAFORMA,IDCONTOVIRTUALE);
            DBMS_OUTPUT.PUT_LINE('HAI VINTO UN PREMIO! DOMANI TI VERRA RILASCIATO');
        
        ELSE
            DBMS_OUTPUT.PUT_LINE('NON HAI RAGGIUNTO I 10 MOVIMENTI NEGLI ULTIMI 30 GIORNI!');
        END IF;
    ELSE 
        DBMS_OUTPUT.PUT_LINE('NON SONO STATI EFFETTUATI SCAMBI DA QUESTO CONTO!');
    END IF;

END ESTRATTO_IN_CRYPTO;
/*
    1- ESTRATTO CONTO E SE NEGLI ULTIMI 30 GIORNI HAI EFFETTUATO ALMENO 10 OPERAIONE ALLORA RICEVRAI UNA REWARDS
    TESTATO E FUNZIONANTE
*/
CREATE OR REPLACE PROCEDURE ESTRATTO_CONTO(CODICEFISCALE_ IN VARCHAR,IDCONTOVIRTUALE_ IN VARCHAR,NOMEP_ IN VARCHAR)
IS
    NOME_ VARCHAR(30);
    COGNOME_ VARCHAR(30);
    MOV VARCHAR(20);
    TOKEN_ VARCHAR(20);
    CONTRATTO_ CHAR(42);
    CONTROLLO NUMBER := 0;
    CONTATORE NUMBER := 0;
    SALDO NUMBER := 0;
    VALUTA_ VARCHAR(20);
BEGIN

    SELECT NOME,COGNOME
    INTO NOME_,COGNOME_
    FROM UTENTE
    WHERE CF = CODICEFISCALE_;

    SELECT COUNT(ID_ORDINE)
    INTO CONTROLLO
    FROM MOVIMENTO
    WHERE ID_CONTO_VIRTUALE_M = IDCONTOVIRTUALE_ AND NOME_PIATTAFORMA_M = NOMEP_;

    IF CONTROLLO > 0 THEN

        DBMS_OUTPUT.PUT_LINE('ESTRATTO CONTO DI ' || NOME_ || ' ' || COGNOME_);
        FOR i IN(
            SELECT ID_ORDINE,QUANTITA_M,DATA_M,FEE_M,TIPO_MOVIMENTO,NUMERO_CARTA_M
            FROM MOVIMENTO
            WHERE ID_CONTO_VIRTUALE_M = IDCONTOVIRTUALE_ AND NOME_PIATTAFORMA_M = NOMEP_
        )

        LOOP
            IF i.TIPO_MOVIMENTO = 1 THEN
                MOV := 'DEPOSITO';
            ELSE
                MOV := 'PRELIEVO';
            END IF;

            DBMS_OUTPUT.PUT_LINE(MOV || ':' || i.QUANTITA_M || '¢' || ' DATA:' || i.DATA_M || ' ' || ' COMMISSIONI:' || i.FEE_M || ' CARTA:' || i.NUMERO_CARTA_M || ' ID:' || i.ID_ORDINE);

        END LOOP;

        SELECT VALUTA
        INTO VALUTA_
        FROM CONTO_VIRTUALE
        WHERE NOME_PIATTAFORMA_CV = NOMEP_ AND ID_CONTO_VIRTUALE = IDCONTOVIRTUALE_;

        SALDO := SALDOVAL(IDCONTOVIRTUALE_,NOMEP_,VALUTA_);
        DBMS_OUTPUT.PUT_LINE('IL SALDO ATTUALE E ' || VALUTA_ || ': ' || SALDO);

        SELECT COUNT(ID_ORDINE)
        INTO CONTATORE
        FROM MOVIMENTO
        WHERE (SYSDATE - DATA_M) <= 30 AND ID_CONTO_VIRTUALE_M = IDCONTOVIRTUALE_ AND NOME_PIATTAFORMA_M = NOMEP_;

        SELECT TOKEN_RIFERIMENTO,CONTRATTO_P
        INTO TOKEN_,CONTRATTO_
        FROM PIATTAFORMA_EXCHANGE
        WHERE NOMEP_ = NOME_PIATTAFORMA;

        IF CONTATORE >= 10 THEN
            INSERT INTO REWARDS(QUANTITA_R,CONTRATTO_R,DATA_RILASCIO,NOME_R,NOME_PIATTAFORMA_R,ID_CONTO_VIRTUALE_R) VALUES
            (10,CONTRATTO_,SYSDATE+1,TOKEN_,NOMEP_,IDCONTOVIRTUALE_);
            DBMS_OUTPUT.PUT_LINE('CIAO ' || NOME_ || ' ' || COGNOME_ || ' HAI VINTO UN PREMIO! DOMANI TI VERRA RILASCIATO');
        ELSE
            DBMS_OUTPUT.PUT_LINE('CIAO ' || NOME_ || ' ' || COGNOME_ || ' NON HAI RAGGIUNTO I 10 MOVIMENTI NEGLI ULTIMI 30 GIORNI!');
        END IF;

    ELSE
        DBMS_OUTPUT.PUT_LINE('SU QUESTO CONTO NON CI SONO MOVIEMNTI!');
    END IF;
 
END ESTRATTO_CONTO;
/*
    2- ELIMINARE DAL DATABASE TUTTE LE CARTE SCADUTE CHE HANNO DEPOSITATO MENO DI 500 E SONO REGISTRATI SUL CONTO VIRTUALE DA MENO DI UN ANNO
       NEL CASO IN CUI IL CONTO VIRTUALE DAL QUALE VIENE CANCELLATA LA CARTA NON HA PIU' NESSUNA CARTA COLLEGATA, ALLORA CANELLA ANCHE ESSO
    TESTATO E FUNZIONANTE
*/
CREATE OR REPLACE PROCEDURE ELIMINARE_CARTE_SCADUTE
IS
    DATACREAZIONE_  DATE;
    TOTDEPOSITI_ NUMBER;
    CONTATORE_ NUMBER;
BEGIN
    FOR i IN
        (
            SELECT NUMERO_CARTA_C,NOME_PIATTAFORMA_C,ID_CONTO_VIRTUALE_C
            FROM COLLEGATO
            WHERE NUMERO_CARTA_C IN (
                SELECT NUMERO_CARTA
                FROM CARTA_DI_CREDITO
                WHERE DATA_DI_SCADENZA < SYSDATE
            )
        )
    LOOP

        SELECT DATA_CREAZIONE
        INTO DATACREAZIONE_
        FROM CONTO_VIRTUALE
        WHERE ID_CONTO_VIRTUALE = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_CV = i.NOME_PIATTAFORMA_C;
        
        TOTDEPOSITI_ := TOTDEPOSITO(i.ID_CONTO_VIRTUALE_C,i.NOME_PIATTAFORMA_C);

        IF TOTDEPOSITI_ < 500 AND ((SYSDATE - DATACREAZIONE_) / 365.25 < 1) THEN
            DELETE FROM CARTA_DI_CREDITO WHERE NUMERO_CARTA = i.NUMERO_CARTA_C;
            DELETE FROM COLLEGATO WHERE NUMERO_CARTA_C = i.NUMERO_CARTA_C AND ID_CONTO_VIRTUALE_C = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_C = i.NOME_PIATTAFORMA_C;
            DBMS_OUTPUT.PUT_LINE('E STATA CANCELLATA LA CARTA NUMERO: ' || i.NUMERO_CARTA_C);
        END IF;
        
        SELECT COUNT(NUMERO_CARTA_C)
        INTO CONTATORE_
        FROM COLLEGATO
        WHERE NUMERO_CARTA_C = i.NUMERO_CARTA_C AND ID_CONTO_VIRTUALE_C = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_C = i.NOME_PIATTAFORMA_C;

        IF CONTATORE_ < 1 THEN
            DELETE FROM CONTO_VIRTUALE WHERE ID_CONTO_VIRTUALE = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_CV = i.NOME_PIATTAFORMA_C;
            DBMS_OUTPUT.PUT_LINE('E STATO CANCELLATO IL CONTO VIRTUALE CON ID: ' || i.ID_CONTO_VIRTUALE_C || ' E NOME: ' || i.NOME_PIATTAFORMA_C);
        END IF;

    END LOOP;

END ELIMINARE_CARTE_SCADUTE;
/*
    3- SI VOGLIONO PREMIARE GLI UTENTI CHE HANNO VERSATO DI PIU'
    TESTATO E FUNZIONANTE
*/
CREATE OR REPLACE PROCEDURE PREMIO
IS
    TOTDEP_ NUMBER;
    MASSIMO NUMBER := 0;
    NOM_    VARCHAR(30);
    COGN_    VARCHAR(30);
    TOKEN VARCHAR(20);
    CONTRATTO_ CHAR(42);
BEGIN

    FOR i IN (
        SELECT ID_CONTO_VIRTUALE,NOME_PIATTAFORMA_CV
        FROM CONTO_VIRTUALE
    )
    LOOP

        TOTDEP_ := TOTDEPOSITO(i.ID_CONTO_VIRTUALE,i.NOME_PIATTAFORMA_CV);

        IF MASSIMO < TOTDEP_ THEN
            MASSIMO := TOTDEP_;
        END IF;

    END LOOP;

    FOR j IN (
        SELECT ID_CONTO_VIRTUALE,NOME_PIATTAFORMA_CV
        FROM CONTO_VIRTUALE
    )
    LOOP

        TOTDEP_ := TOTDEPOSITO(j.ID_CONTO_VIRTUALE,j.NOME_PIATTAFORMA_CV);

        SELECT NOME,COGNOME
        INTO NOM_,COGN_
        FROM UTENTE
        WHERE CF = (
            SELECT CF_UTENTE
            FROM CARTA_DI_CREDITO
            WHERE NUMERO_CARTA = (
                SELECT NUMERO_CARTA_C
                FROM COLLEGATO
                WHERE ID_CONTO_VIRTUALE_C = j.ID_CONTO_VIRTUALE AND NOME_PIATTAFORMA_C = j.NOME_PIATTAFORMA_CV
                FETCH FIRST 1 ROWS ONLY
            )
        );

        SELECT TOKEN_RIFERIMENTO,CONTRATTO_P
        INTO TOKEN,CONTRATTO_
        FROM PIATTAFORMA_EXCHANGE
        WHERE j.NOME_PIATTAFORMA_CV = NOME_PIATTAFORMA;

        IF MASSIMO = TOTDEP_ THEN

            INSERT INTO REWARDS(QUANTITA_R,CONTRATTO_R,DATA_RILASCIO,NOME_R,NOME_PIATTAFORMA_R,ID_CONTO_VIRTUALE_R) VALUES
            (10,CONTRATTO_,SYSDATE+1,TOKEN,j.NOME_PIATTAFORMA_CV,j.ID_CONTO_VIRTUALE);

            DBMS_OUTPUT.PUT_LINE(NOM_ || ' ' || COGN_ || ' HA VINTO UN PREMIO!');
            
        END IF;
    
    END LOOP;
END PREMIO;
/*
    4- ESTRATTO IN CRYPTO COMPRESO DI REWARDS RILASCIATE - SCAMBI EFFETTUATI,
       E SE NEGLI ULTIMI 30 GIORNI HAI EFFETTUATO ALMENO 10 OPERAIONE ALLORA RICEVRAI UNA REWARDS 
*/
CREATE OR REPLACE PROCEDURE ESTRATTO_IN_CRYPTO(IDCONTOVIRTUALE IN VARCHAR,NOMEPIATTAFORMA IN VARCHAR)
IS
    TOKEN_ VARCHAR(20);
    CONTRATTO_ CHAR(42);
    CONTROLLO NUMBER := 0;
    CONTATORE NUMBER := 0;
BEGIN

    SELECT COUNT(TX_HASH)
    INTO CONTROLLO
    FROM SCAMBIO
    WHERE ID_CONTO_VIRTUALE_S = IDCONTOVIRTUALE AND NOME_PIATTAFORMA_S = NOMEPIATTAFORMA;

    IF CONTROLLO > 0 THEN 

        DBMS_OUTPUT.PUT_LINE('ESTRATTO CRYPTO:');
        FOR k IN (
            SELECT *
            FROM SCAMBIO
            WHERE ID_CONTO_VIRTUALE_S = IDCONTOVIRTUALE AND NOME_PIATTAFORMA_S = NOMEPIATTAFORMA
        )
        LOOP
            DBMS_OUTPUT.PUT_LINE(k.VALUTA_OTTENUTA || ':' || k.QUANTITA_OTTENUTA || ' ACQUISTATI CON: ' || k.VALUTA_SCAMBIATA || ':' || k.QUANTITA_SCAMBIATA || ' IN DATA:' || k.DATA_S);
        END LOOP;
        
        DBMS_OUTPUT.PUT_LINE('REWARDS RICEVUTI:');
        FOR i IN (
            SELECT *
            FROM REWARDS
            WHERE ID_CONTO_VIRTUALE_R = IDCONTOVIRTUALE AND NOME_PIATTAFORMA_R = NOMEPIATTAFORMA AND DATA_RILASCIO > SYSDATE+1
        )
        LOOP
            DBMS_OUTPUT.PUT_LINE(i.NOME_R || ':' || i.QUANTITA_R || ' IN DATA:' || i.DATA_RILASCIO);
        END LOOP;

        SELECT COUNT(TX_HASH)
        INTO CONTATORE
        FROM SCAMBIO
        WHERE (SYSDATE - DATA_S) <= 30 AND ID_CONTO_VIRTUALE_S = IDCONTOVIRTUALE AND NOME_PIATTAFORMA_S = NOMEPIATTAFORMA;

        SELECT TOKEN_RIFERIMENTO,CONTRATTO_P
        INTO TOKEN_,CONTRATTO_
        FROM PIATTAFORMA_EXCHANGE
        WHERE NOMEPIATTAFORMA = NOME_PIATTAFORMA;

        IF CONTATORE >= 10 THEN
            INSERT INTO REWARDS(QUANTITA_R,CONTRATTO_R,DATA_RILASCIO,NOME_R,NOME_PIATTAFORMA_R,ID_CONTO_VIRTUALE_R) VALUES
            (10,CONTRATTO_,SYSDATE+1,TOKEN_,NOMEPIATTAFORMA,IDCONTOVIRTUALE);
            DBMS_OUTPUT.PUT_LINE('HAI VINTO UN PREMIO! DOMANI TI VERRA RILASCIATO');
        
        ELSE
            DBMS_OUTPUT.PUT_LINE('NON HAI RAGGIUNTO I 10 MOVIMENTI NEGLI ULTIMI 30 GIORNI!');
        END IF;
    ELSE 
        DBMS_OUTPUT.PUT_LINE('NON SONO STATI EFFETTUATI SCAMBI DA QUESTO CONTO!');
    END IF;

END ESTRATTO_IN_CRYPTO;
/*
    FUNCTION TOTALE DEPOSITI
*/
CREATE OR REPLACE FUNCTION TOTDEPOSITO(IDCONTOVIRTUALE IN VARCHAR,NOMEPIATTAFORMA IN VARCHAR)
RETURN NUMBER
IS
    RETURNVALUE NUMBER;
BEGIN

    RETURNVALUE := 0;

    FOR i IN (
        SELECT QUANTITA_M,TIPO_MOVIMENTO
        FROM MOVIMENTO
        WHERE IDCONTOVIRTUALE = ID_CONTO_VIRTUALE_M AND NOMEPIATTAFORMA = NOME_PIATTAFORMA_M
    )
    LOOP
        IF i.TIPO_MOVIMENTO = 1 THEN
            RETURNVALUE := RETURNVALUE + i.QUANTITA_M;
        END IF;
    END LOOP;

    RETURN RETURNVALUE;

END TOTDEPOSITO;