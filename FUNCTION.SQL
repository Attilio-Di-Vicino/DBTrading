/*
    FUNCTION CHE RESTITUISCE IL SALDO DELLA VALUTA SETTATA NEL CONTO VIRTUALE
*/
CREATE OR REPLACE FUNCTION SALDOVAL(IDCONTOVIRTUALE IN VARCHAR,NOMEPIATTAFORMA IN VARCHAR,VALUTA_ IN VARCHAR)
RETURN NUMBER
IS
    SALDO NUMBER := 0;
    SALDO_VAL_MOV NUMBER := 0;
    SALDO_VAL_SCA NUMBER := 0;
BEGIN

    FOR i IN (
        SELECT *
        FROM MOVIMENTO
        WHERE ID_CONTO_VIRTUALE_M = IDCONTOVIRTUALE AND NOME_PIATTAFORMA_M = NOMEPIATTAFORMA
        ORDER BY DATA_M ASC
    )
    LOOP
        IF i.TIPO_MOVIMENTO = 1 THEN
            SALDO_VAL_MOV := SALDO_VAL_MOV + (i.QUANTITA_M - i.FEE_M);
        ELSE 
            SALDO_VAL_MOV := SALDO_VAL_MOV - (i.QUANTITA_M - i.FEE_M);
        END IF;
    END LOOP;

    FOR j IN (
        SELECT *
        FROM SCAMBIO
        WHERE ID_CONTO_VIRTUALE_S = IDCONTOVIRTUALE AND NOME_PIATTAFORMA_S = NOMEPIATTAFORMA
        ORDER BY DATA_S ASC
    )
    LOOP
        IF j.VALUTA_OTTENUTA = VALUTA_ THEN 
            SALDO_VAL_SCA := SALDO_VAL_SCA + (j.QUANTITA_OTTENUTA - j.FEE_S);
        ELSIF j.VALUTA_SCAMBIATA = VALUTA_ THEN
            SALDO_VAL_SCA := SALDO_VAL_SCA - (j.QUANTITA_SCAMBIATA - j.FEE_S);
        END IF;
    END LOOP;

    SALDO := SALDO_VAL_MOV + SALDO_VAL_SCA;

    RETURN SALDO;

END SALDOVAL;
/*
    FUNCTION CHE RESTITUISCE IL SALDO DELLA CRYPTO CHE DEVE ESSERE SCAMBIATA
*/
CREATE OR REPLACE FUNCTION SALDOCRYPTO(IDCONTOVIRTUALE IN VARCHAR,NOMEPIATTAFORMA IN VARCHAR,VALUTA IN VARCHAR)
RETURN NUMBER
IS
    SALDO NUMBER := 0;
    SALDO_VAL_REW NUMBER := 0;
    SALDO_VAL_SCA NUMBER := 0;
BEGIN

    FOR k IN (
        SELECT *
        FROM SCAMBIO
        WHERE (VALUTA_SCAMBIATA = VALUTA OR VALUTA_OTTENUTA = VALUTA) AND ID_CONTO_VIRTUALE_S = IDCONTOVIRTUALE AND NOME_PIATTAFORMA_S = NOMEPIATTAFORMA
    )
    LOOP
        IF k.VALUTA_OTTENUTA = VALUTA THEN
            SALDO_VAL_SCA := SALDO_VAL_SCA + (k.QUANTITA_OTTENUTA - k.FEE_S);
        ELSE 
            SALDO_VAL_SCA := SALDO_VAL_SCA - (k.QUANTITA_SCAMBIATA - k.FEE_S);
        END IF;
    END LOOP;
    
    FOR i IN (
        SELECT *
        FROM REWARDS
        WHERE NOME_R = VALUTA AND ID_CONTO_VIRTUALE_R = IDCONTOVIRTUALE AND NOME_PIATTAFORMA_R = NOMEPIATTAFORMA AND DATA_RILASCIO > SYSDATE+1
    )
    LOOP
        SALDO_VAL_REW := SALDO_VAL_REW + i.QUANTITA_R;
    END LOOP;

    SALDO := SALDO_VAL_SCA + SALDO_VAL_REW;

    RETURN SALDO;

END SALDOCRYPTO;
/*
    FUNCTION TOTALE DEPOSITI
*/
CREATE OR REPLACE FUNCTION TOTDEPOSITO(IDCONTOVIRTUALE IN VARCHAR,NOMEPIATTAFORMA IN VARCHAR)
RETURN NUMBER
IS
    RETURNVALUE NUMBER;
BEGIN

    RETURNVALUE := 0;

    FOR i IN (
        SELECT QUANTITA_M,TIPO_MOVIMENTO
        FROM MOVIMENTO
        WHERE IDCONTOVIRTUALE = ID_CONTO_VIRTUALE_M AND NOMEPIATTAFORMA = NOME_PIATTAFORMA_M
    )
    LOOP
        IF i.TIPO_MOVIMENTO = 1 THEN
            RETURNVALUE := RETURNVALUE + i.QUANTITA_M;
        END IF;
    END LOOP;

    RETURN RETURNVALUE;

END TOTDEPOSITO;