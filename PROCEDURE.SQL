/*
    1- OGNI 3 MESI VIENE RILASCIATO L'ESTRATTO CONTO
*/

/*
    2- ELIMINARE DAL DATABASE TUTTE LE CARTE SCADUTE CHE HANNO DEPOSITATO MENO DI 500 E SONO REGISTRATI SUL CONTO VIRTUALE DA MENO DI UN ANNO
*/
CREATE OR REPLACE PROCEDURE ELIMINARE_CARTE_SCADUTE
IS
    DATACREAZIONE_  DATE;
    IDCONTOVIRTUALE_ VARCHAR(30);
    NOMEPIATTAFORMA_ VARCHAR(20);
BEGIN
    FOR i IN
        (
            SELECT NUMERO_CARTA
            FROM CARTA_DI_CREDITO
            WHERE DATA_DI_SCADENZA > SYSDATE
        )
    LOOP
        
        SELECT ID_CONTO_VIRTUALE_C,NOME_PIATTAFORMA_C
        INTO IDCONTOVIRTUALE_,NOMEPIATTAFORMA_
        FROM COLLEGATO
        WHERE NUMERO_CARTA_C = i.NUMERO_CARTA;

        SELECT DATA_CREAZIONE
        INTO DATACREAZIONE_
        FROM CONTO_VIRTUALE
        WHERE ID_CONTO_VIRTUALE = IDCONTOVIRTUALE_ AND NOME_PIATTAFORMA_CV = NOMEPIATTAFORMA_

        IF TOTDEPOSITO(IDCONTOVIRTUALE_,NOMEPIATTAFORMA_) < 500 AND DATACREAZIONE_ < 365.25 THEN
            DELETE FROM CARTA_DI_CREDITO WHERE NUMERO_CARTA = i.NUMERO_CARTA;
            DELETE FROM COLLEGATO WHERE NUMERO_CARTA_C = i.NUMERO_CARTA AND ID_CONTO_VIRTUALE_C = IDCONTOVIRTUALE_ AND NOME_PIATTAFORMA_C = NOMEPIATTAFORMA_;
            DBMS_OUTPUT.PUT_LINE('E STATA CANCELLATA LA CARTA NUMERO: ' || i.NUMERO_CARTA);
        END IF;

        IF (
            SELECT COUNT(*)
            FROM COLLEGATO
            WHERE NUMERO_CARTA_C = i.NUMERO_CARTA AND ID_CONTO_VIRTUALE_C = IDCONTOVIRTUALE_ AND NOME_PIATTAFORMA_C = NOMEPIATTAFORMA_
        ) < 1 THEN
            DELETE FROM CONTO_VIRTUALE WHERE ID_CONTO_VIRTUALE = IDCONTOVIRTUALE_ AND NOME_PIATTAFORMA_CV = NOMEPIATTAFORMA_;
            DBMS_OUTPUT.PUT_LINE('E STATO CANCELLATO IL CONTO VIRTUALE CON ID: ' || IDCONTOVIRTUALE_ || 'E NOME: ' || NOMEPIATTAFORMA_);
        END IF;

    END LOOP;

END ELIMINARE_CARTE_SCADUTE;

/*
    3- RICAVO/PERDITA MENSILE
*/

/*
    4- VERIFICA VALIDITA' ACCOUNT
*/

/*
    FUNCTION TOTALE DEPOSITI
*/
CREATE OR REPLACE FUNCTION TOTDEPOSITO(IDCONTOVIRTUALE IN VARCHAR(30),NOMEPIATTAFORMA IN VARCHAR(20), RETURNVALUE OUT NUMBER)
IS
BEGIN

    RETURNVALUE := 0;

    FOR i IN (
        SELECT QUANTITA_M,TIPO_MOVIMENTO
        FROM MOVIMENTO
        WHERE IDCONTOVIRTUALE = ID_CONTO_VIRTUALE_M AND NOMEPIATTAFORMA = NOME_PIATTAFORMA_M;
    )
    LOOP
        IF i.TIPO_MOVIMENTO = 1 THEN
            RETURNVALUE := RETURNVALUE + i.QUANTITA_M;
        END IF;
    END LOOP;

    RETURN;

END TOTDEPOSITO;

