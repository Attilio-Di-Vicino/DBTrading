/*
    1- OGNI 3 MESI VIENE RILASCIATO L'ESTRATTO CONTO
*/
CREATE OR REPLACE PROCEDURE ESTRATTO_CONTO(CODICEFISCALE_ IN VARCHAR)
IS
    NOME_ VARCHAR;
    COGNOME_ VARCHAR;
BEGIN

    SELECT NOME,COGNOME
    INTO NOME_,COGNOME_
    FROM UTENTE
    WHERE CF = CODICEFISCALE_;

    FOR i IN(
                SELECT ID_ORDINE, QUANTITA_M , DATA_M , FEE_M,TIPO_MOVIMENTO, NOME, COGNOME, NUMERO_CARTA_M
                FROM MOVIMENTO
                WHERE NUMERO_CARTA_M = (
                    SELECT NUMERO_CARTA
                    FROM CARTA_DI_CREDITO
                    WHERE CF_UTENTE = CODICEFISCALE_)
    )

    LOOP
        DBMS_OUTPUT.PUT_LINE(NOME_ || COGNOME_ ||  i.ID_ORDINE || i.QUANTITA_M || i.DATA_M || i.FEE_M|| i.TIPO_MOVIMENTO || i.NOME || i.COGNOME|| i.NUMERO_CARTA_M);
    END LOOP;

END ESTRATTO_CONTO;

/*
    2- ELIMINARE DAL DATABASE TUTTE LE CARTE SCADUTE CHE HANNO DEPOSITATO MENO DI 500 E SONO REGISTRATI SUL CONTO VIRTUALE DA MENO DI UN ANNO
*/
CREATE OR REPLACE PROCEDURE ELIMINARE_CARTE_SCADUTE
IS
    DATACREAZIONE_  DATE;
    TOTDEPOSITI_ NUMBER;
    CONTATORE_ NUMBER;
BEGIN
    FOR i IN
        (
            SELECT NUMERO_CARTA_C,NOME_PIATTAFORMA_C,ID_CONTO_VIRTUALE_C
            FROM COLLEGATO
            WHERE NUMERO_CARTA_C IN (
                SELECT NUMERO_CARTA
                FROM CARTA_DI_CREDITO
                WHERE DATA_DI_SCADENZA < SYSDATE
            )
        )
    LOOP

        SELECT DATA_CREAZIONE
        INTO DATACREAZIONE_
        FROM CONTO_VIRTUALE
        WHERE ID_CONTO_VIRTUALE = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_CV = i.NOME_PIATTAFORMA_C;
        
        TOTDEPOSITI_ := TOTDEPOSITO(i.ID_CONTO_VIRTUALE_C,i.NOME_PIATTAFORMA_C);

        IF TOTDEPOSITI_ < 500 AND ((SYSDATE - DATACREAZIONE_) / 365.25 < 1) THEN
            DELETE FROM CARTA_DI_CREDITO WHERE NUMERO_CARTA = i.NUMERO_CARTA_C;
            DELETE FROM COLLEGATO WHERE NUMERO_CARTA_C = i.NUMERO_CARTA_C AND ID_CONTO_VIRTUALE_C = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_C = i.NOME_PIATTAFORMA_C;
            DBMS_OUTPUT.PUT_LINE('E STATA CANCELLATA LA CARTA NUMERO: ' || i.NUMERO_CARTA_C);
        END IF;
        
        SELECT COUNT(NUMERO_CARTA_C)
        INTO CONTATORE_
        FROM COLLEGATO
        WHERE NUMERO_CARTA_C = i.NUMERO_CARTA_C AND ID_CONTO_VIRTUALE_C = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_C = i.NOME_PIATTAFORMA_C;

        IF CONTATORE_ < 1 THEN
            DELETE FROM CONTO_VIRTUALE WHERE ID_CONTO_VIRTUALE = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_CV = i.NOME_PIATTAFORMA_C;
            DBMS_OUTPUT.PUT_LINE('E STATO CANCELLATO IL CONTO VIRTUALE CON ID: ' || i.ID_CONTO_VIRTUALE_C || ' E NOME: ' || i.NOME_PIATTAFORMA_C);
        END IF;

    END LOOP;

END ELIMINARE_CARTE_SCADUTE;

/*
    3- RICAVO/PERDITA MENSILE
*/

/*
    4- VERIFICA VALIDITA' ACCOUNT
*/

/*
    FUNCTION TOTALE DEPOSITI
*/
CREATE OR REPLACE FUNCTION TOTDEPOSITO(IDCONTOVIRTUALE IN VARCHAR(30),NOMEPIATTAFORMA IN VARCHAR(20))
RETURN NUMBER
IS
    RETURNVALUE NUMBER;
BEGIN

    RETURNVALUE := 0;

    FOR i IN (
        SELECT QUANTITA_M,TIPO_MOVIMENTO
        FROM MOVIMENTO
        WHERE IDCONTOVIRTUALE = ID_CONTO_VIRTUALE_M AND NOMEPIATTAFORMA = NOME_PIATTAFORMA_M
    )
    LOOP
        IF i.TIPO_MOVIMENTO = 1 THEN
            RETURNVALUE := RETURNVALUE + i.QUANTITA_M;
        END IF;
    END LOOP;

    RETURN RETURNVALUE;

END TOTDEPOSITO;

