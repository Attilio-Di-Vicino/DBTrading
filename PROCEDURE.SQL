/*
    1- ESTRATTO CONTO
    TESTATO E FUNZIONANTE
*/
CREATE OR REPLACE PROCEDURE ESTRATTO_CONTO(CODICEFISCALE_ IN VARCHAR)
IS
    NOME_ VARCHAR(30);
    COGNOME_ VARCHAR(30);
    MOV VARCHAR(20);
BEGIN

    SELECT NOME,COGNOME
    INTO NOME_,COGNOME_
    FROM UTENTE
    WHERE CF = CODICEFISCALE_;

    DBMS_OUTPUT.PUT_LINE('ESTRATTO CONTO DI ' || NOME_ || ' ' || COGNOME_);
    FOR i IN(
                SELECT ID_ORDINE,QUANTITA_M,DATA_M,FEE_M,TIPO_MOVIMENTO,NUMERO_CARTA_M
                FROM MOVIMENTO
                WHERE NUMERO_CARTA_M IN (
                    SELECT NUMERO_CARTA
                    FROM CARTA_DI_CREDITO
                    WHERE CF_UTENTE = CODICEFISCALE_)
    )

    LOOP
        IF i.TIPO_MOVIMENTO = 1 THEN
            MOV = 'DEPOSITO';
        ELSE
            MOV = 'PRELIEVO';

        DBMS_OUTPUT.PUT_LINE(MOV || ':' || i.QUANTITA_M || 'Â¢' || ' DATA:' || i.DATA_M || ' ' || ' COMMISSIONI:' || i.FEE_M || ' CARTA:' || i.NUMERO_CARTA_M || ' ID:' || i.ID_ORDINE);
    END LOOP;

END ESTRATTO_CONTO;

/*
    2- ELIMINARE DAL DATABASE TUTTE LE CARTE SCADUTE CHE HANNO DEPOSITATO MENO DI 500 E SONO REGISTRATI SUL CONTO VIRTUALE DA MENO DI UN ANNO
       NEL CASO IN CUI IL CONTO VIRTUALE DAL QUALE VIENE CANCELLATA LA CARTA NON HA PIU' NESSUNA CARTA COLLEGATA, ALLORA CANELLA ANCHE ESSO
    TESTATO E FUNZIONANTE
*/
CREATE OR REPLACE PROCEDURE ELIMINARE_CARTE_SCADUTE
IS
    DATACREAZIONE_  DATE;
    TOTDEPOSITI_ NUMBER;
    CONTATORE_ NUMBER;
BEGIN
    FOR i IN
        (
            SELECT NUMERO_CARTA_C,NOME_PIATTAFORMA_C,ID_CONTO_VIRTUALE_C
            FROM COLLEGATO
            WHERE NUMERO_CARTA_C IN (
                SELECT NUMERO_CARTA
                FROM CARTA_DI_CREDITO
                WHERE DATA_DI_SCADENZA < SYSDATE
            )
        )
    LOOP

        SELECT DATA_CREAZIONE
        INTO DATACREAZIONE_
        FROM CONTO_VIRTUALE
        WHERE ID_CONTO_VIRTUALE = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_CV = i.NOME_PIATTAFORMA_C;
        
        TOTDEPOSITI_ := TOTDEPOSITO(i.ID_CONTO_VIRTUALE_C,i.NOME_PIATTAFORMA_C);

        IF TOTDEPOSITI_ < 500 AND ((SYSDATE - DATACREAZIONE_) / 365.25 < 1) THEN
            DELETE FROM CARTA_DI_CREDITO WHERE NUMERO_CARTA = i.NUMERO_CARTA_C;
            DELETE FROM COLLEGATO WHERE NUMERO_CARTA_C = i.NUMERO_CARTA_C AND ID_CONTO_VIRTUALE_C = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_C = i.NOME_PIATTAFORMA_C;
            DBMS_OUTPUT.PUT_LINE('E STATA CANCELLATA LA CARTA NUMERO: ' || i.NUMERO_CARTA_C);
        END IF;
        
        SELECT COUNT(NUMERO_CARTA_C)
        INTO CONTATORE_
        FROM COLLEGATO
        WHERE NUMERO_CARTA_C = i.NUMERO_CARTA_C AND ID_CONTO_VIRTUALE_C = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_C = i.NOME_PIATTAFORMA_C;

        IF CONTATORE_ < 1 THEN
            DELETE FROM CONTO_VIRTUALE WHERE ID_CONTO_VIRTUALE = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_CV = i.NOME_PIATTAFORMA_C;
            DBMS_OUTPUT.PUT_LINE('E STATO CANCELLATO IL CONTO VIRTUALE CON ID: ' || i.ID_CONTO_VIRTUALE_C || ' E NOME: ' || i.NOME_PIATTAFORMA_C);
        END IF;

    END LOOP;

END ELIMINARE_CARTE_SCADUTE;

/*
    3- SI VOGLIONO PREMIARE GLI UTENTI CHE HANNO VERSATO DI PIU'
    TESTATO E FUNZIONANTE
*/
CREATE OR REPLACE PROCEDURE PREMIO
IS
    TOTDEP_ NUMBER;
    MASSIMO NUMBER := 0;
    NOM_    VARCHAR(30);
    COGN_    VARCHAR(30);
BEGIN

    FOR i IN (
        SELECT ID_CONTO_VIRTUALE,NOME_PIATTAFORMA_CV
        FROM CONTO_VIRTUALE
    )
    LOOP

        TOTDEP_ := TOTDEPOSITO(i.ID_CONTO_VIRTUALE,i.NOME_PIATTAFORMA_CV);

        IF MASSIMO < TOTDEP_ THEN
            MASSIMO := TOTDEP_;
        END IF;

    END LOOP;

    FOR j IN (
        SELECT ID_CONTO_VIRTUALE,NOME_PIATTAFORMA_CV
        FROM CONTO_VIRTUALE
    )
    LOOP

        TOTDEP_ := TOTDEPOSITO(j.ID_CONTO_VIRTUALE,j.NOME_PIATTAFORMA_CV);

        SELECT NOME,COGNOME
        INTO NOM_,COGN_
        FROM UTENTE
        WHERE CF = (
            SELECT CF_UTENTE
            FROM CARTA_DI_CREDITO
            WHERE NUMERO_CARTA = (
                SELECT NUMERO_CARTA_C
                FROM COLLEGATO
                WHERE ID_CONTO_VIRTUALE_C = j.ID_CONTO_VIRTUALE AND NOME_PIATTAFORMA_C = j.NOME_PIATTAFORMA_CV
                FETCH FIRST 1 ROWS ONLY
            )
        );

        IF MASSIMO = TOTDEP_ THEN

            INSERT INTO REWARDS(QUANTITA_R,BLOCKCHAIN_R,CONTRATTO_R,DATA_RILASCIO,NOME_R,NOME_PIATTAFORMA_R,ID_CONTO_VIRTUALE_R) VALUES
            (10,'BSC','0xKaP7e0yhG0X0GHwZJnv7d3Oe0S0DGj6uovM4MDpL',SYSDATE+1,'BNB',j.NOME_PIATTAFORMA_CV,j.ID_CONTO_VIRTUALE);

            DBMS_OUTPUT.PUT_LINE('CIAO ' || NOM_ || ' ' || COGN_ || ' HAI VINTO UN PREMIO! DOMANI TI VERRA RILASCIATO');
            
        END IF;
    
    END LOOP;
END PREMIO;

/*
    4- ELIMINAZIONE REWARDS UNA VOLTA CHE SONO STATE RILASCIATE
    TESTATE TUTTE E DUE LE PROCEDURE CREATE DA VALUTARE QUALE UTILIZZARE
*/
CREATE OR REPLACE PROCEDURE ELIMINA_REWARDS_RILASCIATA
IS
    NOMEINTER VARCHAR(20);
    COGNOMEINTER VARCHAR(20);
BEGIN

    FOR i IN (
        SELECT DATA_RILASCIO,CODICE
        FROM REWARDS
    )
    LOOP
        IF i.DATA_RILASCIO <= SYSDATE THEN -- CONTROLLARE <= E POI BISOGNA CANCELLARLE SOLO IL GIORNO DOPO AVERLE RICEVUTE
            
            SELECT NOME,COGNOME
            INTO NOMEINTER,COGNOMEINTER
            FROM UTENTE 
            WHERE CF = (
                SELECT CF_UTENTE
                FROM CARTA_DI_CREDITO
                WHERE NUMERO_CARTA = (
                    SELECT NUMERO_CARTA_C
                    FROM COLLEGATO
                    WHERE ID_CONTO_VIRTUALE_C IN (
                        SELECT ID_CONTO_VIRTUALE
                        FROM CONTO_VIRTUALE
                        WHERE ID_CONTO_VIRTUALE = (
                            SELECT ID_CONTO_VIRTUALE_R
                            FROM REWARDS
                            WHERE CODICE = i.CODICE
                        )
                    ) AND NOME_PIATTAFORMA_C IN (
                        SELECT NOME_PIATTAFORMA_CV
                        FROM CONTO_VIRTUALE
                        WHERE NOME_PIATTAFORMA_CV = (
                            SELECT NOME_PIATTAFORMA_R
                            FROM REWARDS
                            WHERE CODICE = i.CODICE
                        )
                    )
                )
                FETCH FIRST 1 ROWS ONLY
            );

            DELETE FROM REWARDS WHERE CODICE = i.CODICE;

            DBMS_OUTPUT.PUT_LINE('CIAO ' || NOMEINTER || ' ' || COGNOMEINTER || ' HAI RICEVUTO UN PREMIO!');
        ELSE 
            DBMS_OUTPUT.PUT_LINE('NESSUNA REWARDS DA RILASCIARE!');
        END IF;
    END LOOP;
END ELIMINA_REWARDS_RILASCIATA;
-------------------------------------
-- VERSIONE 2
CREATE OR REPLACE PROCEDURE ELIMINA_REWARDS_RILASCIATA
IS
    NOME_ VARCHAR(20);
    COGNOME_ VARCHAR(20);
BEGIN

    FOR i IN (
        SELECT DATA_RILASCIO,CODICE
        FROM REWARDS
    )
    LOOP
        IF i.DATA_RILASCIO <= SYSDATE THEN
            DELETE FROM REWARDS WHERE CODICE = i.CODICE;
            DBMS_OUTPUT.PUT_LINE('REWARDS RILASCIATA E CANCELLATA: ' || i.CODICE);
        END IF;
    END LOOP;
END ELIMINA_REWARDS_RILASCIATA;
/*
    5- ESTRATTO IN CRYPTO COMPRESO DI REWARDS RILASCIATE - SCAMBI EFFETTUATI 
*/
CREATE OR REPLACE PROCEDURE ESTRATTO_IN_CRYPTO(IDCONTOVIRTUALE IN VARCHAR,NOMEPIATTAFORMA IN VARCHAR)
IS
BEGIN

    DBMS_OUTPUT.PUT_LINE('ESTRATTO CRYPTO:');
    FOR k IN (
        SELECT *
        FROM SCAMBIO
        WHERE ID_CONTO_VIRTUALE_S = IDCONTOVIRTUALE AND NOME_PIATTAFORMA_S = NOMEPIATTAFORMA
    )
    LOOP
        DBMS_OUTPUT.PUT_LINE(k.VALUTA_OTTENUTA || ':' || k.QUANTITA_OTTENUTA || ' ACQUISTATI CON: ' || k.VALUTA_SCAMBIATA || ':' || k.QUANTITA_SCAMBIATA || ' IN DATA:' || k.DATA_S);
    END LOOP;
    
    DBMS_OUTPUT.PUT_LINE('REWARDS RICEVUTI:');
    FOR i IN (
        SELECT *
        FROM REWARDS
        WHERE ID_CONTO_VIRTUALE_R = IDCONTOVIRTUALE AND NOME_PIATTAFORMA_R = NOMEPIATTAFORMA AND DATA_RILASCIO > SYSDATE+1
    )
    LOOP
        DBMS_OUTPUT.PUT_LINE(i.NOME_R || ':' || i.QUANTITA_R || ' IN DATA:' || i.DATA_RILASCIO);
    END LOOP;

END ESTRATTO_IN_CRYPTO;
/*
    FUNCTION TOTALE DEPOSITI
*/
CREATE OR REPLACE FUNCTION TOTDEPOSITO(IDCONTOVIRTUALE IN VARCHAR,NOMEPIATTAFORMA IN VARCHAR)
RETURN NUMBER
IS
    RETURNVALUE NUMBER;
BEGIN

    RETURNVALUE := 0;

    FOR i IN (
        SELECT QUANTITA_M,TIPO_MOVIMENTO
        FROM MOVIMENTO
        WHERE IDCONTOVIRTUALE = ID_CONTO_VIRTUALE_M AND NOMEPIATTAFORMA = NOME_PIATTAFORMA_M
    )
    LOOP
        IF i.TIPO_MOVIMENTO = 1 THEN
            RETURNVALUE := RETURNVALUE + i.QUANTITA_M;
        END IF;
    END LOOP;

    RETURN RETURNVALUE;

END TOTDEPOSITO;

/*
    6- RICAVO/PERDITA MENSILE?
*/

/*
    7- VERIFICA VALIDITA' ACCOUNT?
*/