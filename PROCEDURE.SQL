/*
    1- ELIMINARE DAL DATABASE TUTTE LE CARTE SCADUTE CHE HANNO DEPOSITATO MENO DI 500 E SONO COLLEGATE SUL CONTO VIRTUALE DA MENO DI UN ANNO
       NEL CASO IN CUI IL CONTO VIRTUALE DAL QUALE VIENE CANCELLATA LA CARTA NON HA PIU' NESSUNA CARTA COLLEGATA, ALLORA CANELLA ANCHE ESSO
    TESTATO E FUNZIONANTE
*/
CREATE OR REPLACE PROCEDURE ELIMINARE_CARTE_SCADUTE
IS
    DATACREAZIONE_  DATE;
    TOTDEPOSITI_ NUMBER;
    CONTATORE_ NUMBER;
BEGIN
    FOR i IN
        (
            SELECT NUMERO_CARTA_C,NOME_PIATTAFORMA_C,ID_CONTO_VIRTUALE_C
            FROM COLLEGATO
            WHERE NUMERO_CARTA_C IN (
                SELECT NUMERO_CARTA
                FROM CARTA_DI_CREDITO
                WHERE DATA_DI_SCADENZA < SYSDATE
            )
        )
    LOOP

        SELECT DATA_CREAZIONE
        INTO DATACREAZIONE_
        FROM CONTO_VIRTUALE
        WHERE ID_CONTO_VIRTUALE = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_CV = i.NOME_PIATTAFORMA_C;
        
        TOTDEPOSITI_ := TOTDEPOSITO(i.ID_CONTO_VIRTUALE_C,i.NOME_PIATTAFORMA_C);

        IF TOTDEPOSITI_ < 500 AND ((SYSDATE - DATACREAZIONE_) / 365.25 < 1) THEN
            DELETE FROM CARTA_DI_CREDITO WHERE NUMERO_CARTA = i.NUMERO_CARTA_C;
            DELETE FROM COLLEGATO WHERE NUMERO_CARTA_C = i.NUMERO_CARTA_C AND ID_CONTO_VIRTUALE_C = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_C = i.NOME_PIATTAFORMA_C;
            DBMS_OUTPUT.PUT_LINE('E STATA CANCELLATA LA CARTA NUMERO: ' || i.NUMERO_CARTA_C);
        END IF;
        
        SELECT COUNT(NUMERO_CARTA_C)
        INTO CONTATORE_
        FROM COLLEGATO
        WHERE NUMERO_CARTA_C = i.NUMERO_CARTA_C AND ID_CONTO_VIRTUALE_C = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_C = i.NOME_PIATTAFORMA_C;

        IF CONTATORE_ < 1 THEN
            DELETE FROM CONTO_VIRTUALE WHERE ID_CONTO_VIRTUALE = i.ID_CONTO_VIRTUALE_C AND NOME_PIATTAFORMA_CV = i.NOME_PIATTAFORMA_C;
            DBMS_OUTPUT.PUT_LINE('E STATO CANCELLATO IL CONTO VIRTUALE CON ID: ' || i.ID_CONTO_VIRTUALE_C || ' E NOME: ' || i.NOME_PIATTAFORMA_C);
        END IF;

    END LOOP;

END ELIMINARE_CARTE_SCADUTE;
/*
    2- SI VOGLIONO PREMIARE GLI UTENTI CHE HANNO VERSATO DI PIU' SU OGNI SINGOLO CONTO
    TESTATO E FUNZIONANTE
*/
CREATE OR REPLACE PROCEDURE PREMIO
IS
    TOTDEP_ NUMBER;
    MASSIMO NUMBER := 0;
    NOM_    VARCHAR(30);
    COGN_    VARCHAR(30);
    TOKEN VARCHAR(20);
    CONTRATTO_ CHAR(42);
    QUANTITAR NUMBER;
BEGIN

    FOR i IN (
        SELECT ID_CONTO_VIRTUALE,NOME_PIATTAFORMA_CV
        FROM CONTO_VIRTUALE
    )
    LOOP

        TOTDEP_ := TOTDEPOSITO(i.ID_CONTO_VIRTUALE,i.NOME_PIATTAFORMA_CV);

        IF MASSIMO < TOTDEP_ THEN
            MASSIMO := TOTDEP_;
        END IF;

    END LOOP;

    FOR j IN (
        SELECT ID_CONTO_VIRTUALE,NOME_PIATTAFORMA_CV
        FROM CONTO_VIRTUALE
    )
    LOOP

        TOTDEP_ := TOTDEPOSITO(j.ID_CONTO_VIRTUALE,j.NOME_PIATTAFORMA_CV);

        SELECT NOME,COGNOME
        INTO NOM_,COGN_
        FROM UTENTE
        WHERE CF = (
            SELECT CF_UTENTE
            FROM CARTA_DI_CREDITO
            WHERE NUMERO_CARTA = (
                SELECT NUMERO_CARTA_C
                FROM COLLEGATO
                WHERE ID_CONTO_VIRTUALE_C = j.ID_CONTO_VIRTUALE AND NOME_PIATTAFORMA_C = j.NOME_PIATTAFORMA_CV
                FETCH FIRST 1 ROWS ONLY
            )
        );

        SELECT TOKEN_RIFERIMENTO
        INTO TOKEN
        FROM PIATTAFORMA_EXCHANGE
        WHERE j.NOME_PIATTAFORMA_CV = NOME_PIATTAFORMA;

        IF MASSIMO = TOTDEP_ THEN

        QUANTITAR := FLOOR(MASSIMO/100);

            INSERT INTO REWARDS(QUANTITA_R,DATA_RILASCIO,NOME_R,NOME_PIATTAFORMA_R,ID_CONTO_VIRTUALE_R) VALUES
            (QUANTITAR,SYSDATE+1,TOKEN,j.NOME_PIATTAFORMA_CV,j.ID_CONTO_VIRTUALE);

            DBMS_OUTPUT.PUT_LINE(NOM_ || ' ' || COGN_ || ' HA VINTO UN PREMIO!');
            
        END IF;
    
    END LOOP;
END PREMIO;
/*
    3- RILASCIO DI UNA REWARDS NEL CASO IN CUI NEGLI ULTIMI 30 GIORNI SONO STATI EFFETTUATI ALMENO 10 OPERAZIONE DI SCAMBIO
*/
CREATE OR REPLACE PROCEDURE PREMIO_SCAMBI
IS
    NOME VARCHAR(20);
    COGNOME VARCHAR(20);
    CONTATORE NUMBER := 0;
    TOKEN_ VARCHAR(20);
BEGIN

    FOR i IN (
        SELECT ID_CONTO_VIRTUALE,NOME_PIATTAFORMA_CV
        FROM CONTO_VIRTUALE
    )
    LOOP

        SELECT NOME,COGNOME
        INTO NOME,COGNOME
        FROM UTENTE
        WHERE CF IN (
            SELECT CF_UTENTE
            FROM CARTA_DI_CREDITO
            WHERE NUMERO_CARTA IN (
                SELECT NUMERO_CARTA_C
                FROM COLLEGATO
                WHERE ID_CONTO_VIRTUALE_C = i.ID_CONTO_VIRTUALE AND NOME_PIATTAFORMA_C = i.NOME_PIATTAFORMA_CV
                FETCH FIRST 1 ROWS ONLY
            )
        );

        SELECT TOKEN_RIFERIMENTO
        INTO TOKEN_
        FROM PIATTAFORMA_EXCHANGE
        WHERE NOME_PIATTAFORMA = i.NOME_PIATTAFORMA_CV;

        SELECT COUNT(TX_HASH)
        INTO CONTATORE
        FROM SCAMBIO
        WHERE ID_CONTO_VIRTUALE_S = i.ID_CONTO_VIRTUALE AND NOME_PIATTAFORMA_S = i.NOME_PIATTAFORMA_CV AND (SYSDATE - DATA_S) <= 30;

        IF CONTATORE >= 10 THEN
            INSERT INTO REWARDS(QUANTITA_R,DATA_RILASCIO,NOME_R,NOME_PIATTAFORMA_R,ID_CONTO_VIRTUALE_R) VALUES
            (CONTATORE,SYSDATE+1,TOKEN_,i.NOME_PIATTAFORMA_CV,i.ID_CONTO_VIRTUALE);

            DBMS_OUTPUT.PUT_LINE('UTENTE ' || NOME || ' ' || COGNOME || ' HA EFFETTUATO '|| CONTATORE || ' SCAMBI, HA VINTO UN PREMIO CHE VERRA RILASCIATO DOMANI!');
        ELSE 
            DBMS_OUTPUT.PUT_LINE('UTENTE ' || NOME || ' ' || COGNOME || ' HA EFFETTUATO '|| CONTATORE || ' SCAMBI, NON HA VINTO NESSUN PREMIO!');
        END IF;

    END LOOP;

END PREMIO_SCAMBI;
/*
    4- AUMENTA IL RISCHIO SE ALMENO IN UN CONTO VIRTUALE PERSONALE HAI UN SALDO >= DI 500
*/
CREATE OR REPLACE PROCEDURE AUMENTA_RISCHIO(CODICEFISCALE IN VARCHAR)
IS
    VALUTA VARCHAR(20);
    SALDO NUMBER;
    RIS NUMBER;
    AU_RIS NUMBER;
    CATE VARCHAR(20);
    CONTROLLO NUMBER := 0;
BEGIN

    FOR i IN (
        SELECT ID_CONTO_VIRTUALE_C,NOME_PIATTAFORMA_C
        FROM COLLEGATO
        WHERE NUMERO_CARTA_C IN (
            SELECT NUMERO_CARTA
            FROM CARTA_DI_CREDITO
            WHERE CARTA_DI_CREDITO.CF_UTENTE = CODICEFISCALE
        )
    )
    LOOP

        SELECT TOKEN_RIFERIMENTO
        INTO VALUTA
        FROM PIATTAFORMA_EXCHANGE
        WHERE NOME_PIATTAFORMA = i.NOME_PIATTAFORMA_C;

        SALDO := SALDOVAL(i.ID_CONTO_VIRTUALE_C,i.NOME_PIATTAFORMA_C,VALUTA);

        SELECT RISCHIO,AUMENTO_RISCHIO,CATEGORIA
        INTO RIS,AU_RIS,CATE
        FROM VALUTAZIONE_RISCHIO
        WHERE VALUTAZIONE_RISCHIO.CF_UTENTE = CODICEFISCALE;

        IF SALDO >= 500 THEN
            CONTROLLO := 1;
        END IF;
    
    END LOOP;

    IF CONTROLLO = 1 THEN
        UPDATE VALUTAZIONE_RISCHIO SET RISCHIO = RIS + AU_RIS WHERE CATEGORIA = CATE AND VALUTAZIONE_RISCHIO.CF_UTENTE = CODICEFISCALE;
        COMMIT;
        DBMS_OUTPUT.PUT_LINE('IL TUO RISCHIO E AUMENTATO');
    ELSE
        DBMS_OUTPUT.PUT_LINE('IL TUO RISCHIO NON E AUMENTATO');
    END IF;

END AUMENTA_RISCHIO;
/*
    5- ESTRATTO CONTO MOVIMENTI E SCAMBI
*/
CREATE OR REPLACE PROCEDURE ESTRATTO(CODFISCALE IN VARCHAR)
IS
    MOV VARCHAR(20);
BEGIN

    DBMS_OUTPUT.PUT_LINE('ESTRATTO CONTO:');
    FOR i IN (
        SELECT TIPO_MOVIMENTO,QUANTITA_M,DATA_M,NUMERO_CARTA_M,FEE_M
        FROM MOVIMENTO 
        WHERE NUMERO_CARTA_M IN (
            SELECT NUMERO_CARTA
            FROM CARTA_DI_CREDITO
            WHERE CF_UTENTE = CODFISCALE
        )
        ORDER BY DATA_M ASC
    )
    LOOP
        IF i.TIPO_MOVIMENTO = 1 THEN
            MOV := 'DEPOSITO';
        ELSE
            MOV := 'PRELIEVO';
        END IF;

        DBMS_OUTPUT.PUT_LINE(MOV || ':' || i.QUANTITA_M || 'Â¢' || ' DATA:' || i.DATA_M || ' ' || ' COMMISSIONI:' || i.FEE_M || ' CARTA:' || i.NUMERO_CARTA_M);
    END LOOP;

    DBMS_OUTPUT.PUT_LINE('ESTRATTO CRYPTO:');
    FOR j IN (
        SELECT VALUTA_OTTENUTA,QUANTITA_OTTENUTA,VALUTA_SCAMBIATA,QUANTITA_SCAMBIATA,DATA_S,FEE_S
        FROM SCAMBIO
        WHERE ID_CONTO_VIRTUALE_S IN (
            SELECT ID_CONTO_VIRTUALE_C
            FROM COLLEGATO
            WHERE NUMERO_CARTA_C IN (
                SELECT NUMERO_CARTA
                FROM CARTA_DI_CREDITO
                WHERE CF_UTENTE = CODFISCALE
            )
        ) AND NOME_PIATTAFORMA_S IN (
            SELECT NOME_PIATTAFORMA_C
            FROM COLLEGATO
            WHERE NUMERO_CARTA_C IN (
                SELECT NUMERO_CARTA
                FROM CARTA_DI_CREDITO
                WHERE CF_UTENTE = CODFISCALE
            )
        )
        ORDER BY DATA_S ASC
    )
    LOOP
        DBMS_OUTPUT.PUT_LINE(j.VALUTA_OTTENUTA || ':' || j.QUANTITA_OTTENUTA || ' ACQUISTATI CON: ' || j.VALUTA_SCAMBIATA || ':' || j.QUANTITA_SCAMBIATA || ' FEE PAGATE:' || j.FEE_S ||' IN DATA:' || j.DATA_S);
    END LOOP;

END ESTRATTO;